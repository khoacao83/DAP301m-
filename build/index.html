<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Dashboard</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        border: "hsl(214.3, 31.8%, 91.4%)",
                        input: "hsl(214.3, 31.8%, 91.4%)",
                        ring: "hsl(222.2, 84%, 4.9%)",
                        background: "hsl(0, 0%, 100%)",
                        foreground: "hsl(222.2, 84%, 4.9%)",
                        primary: {
                            DEFAULT: "hsl(222.2, 47.4%, 11.2%)",
                            foreground: "hsl(210, 40%, 98%)",
                        },
                        secondary: {
                            DEFAULT: "hsl(210, 40%, 96%)",
                            foreground: "hsl(222.2, 84%, 4.9%)",
                        },
                        muted: {
                            DEFAULT: "hsl(210, 40%, 96%)",
                            foreground: "hsl(215.4, 16.3%, 46.9%)",
                        },
                        accent: {
                            DEFAULT: "hsl(210, 40%, 96%)",
                            foreground: "hsl(222.2, 84%, 4.9%)",
                        },
                        card: {
                            DEFAULT: "hsl(0, 0%, 100%)",
                            foreground: "hsl(222.2, 84%, 4.9%)",
                        },
                    },
                }
            }
        }
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        }
        .weather-card-gradient {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(147, 51, 234, 0.1) 100%);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // Utility functions
        const cn = (...classes) => classes.filter(Boolean).join(' ');
        
        const formatTemperature = (temp) => `${Math.round(temp)}¬∞`;
        
        const getWeatherIcon = (condition) => {
            const iconMap = {
                'clear': '‚òÄÔ∏è', 'sunny': '‚òÄÔ∏è', 'partly cloudy': '‚õÖ', 'cloudy': '‚òÅÔ∏è',
                'overcast': '‚òÅÔ∏è', 'rainy': 'üåßÔ∏è', 'rain': 'üåßÔ∏è', 'drizzle': 'üå¶Ô∏è',
                'thunderstorm': '‚õàÔ∏è', 'snow': '‚ùÑÔ∏è', 'fog': 'üå´Ô∏è', 'mist': 'üå´Ô∏è', 'haze': 'üå´Ô∏è'
            };
            return iconMap[condition.toLowerCase()] || 'üå§Ô∏è';
        };

        // Card Components
        const Card = ({ children, className, onClick }) => (
            <div className={cn("rounded-lg border bg-white shadow-sm", className)} onClick={onClick}>
                {children}
            </div>
        );

        const CardHeader = ({ children, className }) => (
            <div className={cn("flex flex-col space-y-1.5 p-6", className)}>
                {children}
            </div>
        );

        const CardTitle = ({ children, className }) => (
            <h3 className={cn("text-2xl font-semibold leading-none tracking-tight", className)}>
                {children}
            </h3>
        );

        const CardDescription = ({ children, className }) => (
            <p className={cn("text-sm text-gray-600", className)}>
                {children}
            </p>
        );

        const CardContent = ({ children, className }) => (
            <div className={cn("p-6 pt-0", className)}>
                {children}
            </div>
        );

        // Simple SVG Icons
        const HomeIcon = () => (
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                <polyline points="9,22 9,12 15,12 15,22" />
            </svg>
        );

        const ChartIcon = () => (
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 3v18h18" />
                <path d="m19 9-5 5-4-4-3 3" />
            </svg>
        );

        const BrainIcon = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
        );

        const SettingsIcon = () => (
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        );

        const ArrowRightIcon = () => (
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
            </svg>
        );

        const UploadIcon = () => (
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
            </svg>
        );

        const DatabaseIcon = () => (
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
                <path d="m3 5 0 14c0 1.7 4 3 9 3s9-1.3 9-3V5"></path>
                <path d="m3 12c0 1.7 4 3 9 3s9-1.3 9-3"></path>
            </svg>
        );

        const FileTextIcon = () => (
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
        );

        // Button Component
        const Button = ({ children, onClick, disabled, variant = "default", size = "default", className }) => {
            const baseClasses = "inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50";
            const variants = {
                default: "bg-blue-600 text-white hover:bg-blue-700",
                outline: "border border-gray-300 bg-transparent hover:bg-gray-100",
                secondary: "bg-gray-100 text-gray-900 hover:bg-gray-200"
            };
            const sizes = {
                default: "h-10 px-4 py-2",
                sm: "h-9 px-3 text-sm",
                lg: "h-11 px-8"
            };
            
            return (
                <button
                    className={cn(baseClasses, variants[variant], sizes[size], className)}
                    onClick={onClick}
                    disabled={disabled}
                >
                    {children}
                </button>
            );
        };

        // Weather Detail Item Component
        const WeatherDetailItem = ({ icon, label, value, unit }) => (
            <div className="flex items-center justify-between p-3 rounded-lg bg-white/10 backdrop-blur-sm">
                <div className="flex items-center gap-3">
                    <span className="text-lg">{icon}</span>
                    <span className="text-sm font-medium text-white/90">{label}</span>
                </div>
                <span className="text-sm font-semibold text-white">
                    {value}{unit}
                </span>
            </div>
        );

        // Weather Card Component
        const WeatherCard = ({ weather, loading }) => {
            if (loading) {
                return (
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="lg:col-span-2">
                            <Card className="h-80 bg-gradient-to-br from-blue-500 to-purple-600 border-0 animate-pulse">
                                <div className="p-8 h-full flex flex-col justify-between text-white">
                                    <div className="space-y-4">
                                        <div className="h-6 bg-white/20 rounded w-48"></div>
                                        <div className="h-20 bg-white/20 rounded w-32"></div>
                                        <div className="h-4 bg-white/20 rounded w-64"></div>
                                    </div>
                                </div>
                            </Card>
                        </div>
                        <div>
                            <Card className="h-80 bg-gray-100 border-0 animate-pulse">
                                <div className="p-6 space-y-4">
                                    {Array.from({ length: 6 }).map((_, i) => (
                                        <div key={i} className="h-12 bg-gray-200 rounded"></div>
                                    ))}
                                </div>
                            </Card>
                        </div>
                    </div>
                );
            }

            if (!weather) {
                return (
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="lg:col-span-3">
                            <Card className="h-64 bg-gradient-to-br from-gray-400 to-gray-600 border-0">
                                <div className="p-8 h-full flex flex-col items-center justify-center text-white">
                                    <div className="text-6xl mb-4">‚ö†Ô∏è</div>
                                    <h3 className="text-xl font-semibold mb-2">Weather Data Unavailable</h3>
                                    <p className="text-white/80 text-center max-w-md">
                                        Unable to fetch current weather data. Please check your API settings or try again later.
                                    </p>
                                </div>
                            </Card>
                        </div>
                    </div>
                );
            }

            const gradientClass = cn(
                "bg-gradient-to-br border-0",
                weather.description.toLowerCase().includes('clear') && "from-blue-400 to-blue-600",
                weather.description.toLowerCase().includes('cloud') && "from-gray-400 to-gray-600",
                weather.description.toLowerCase().includes('rain') && "from-blue-600 to-indigo-800",
                weather.description.toLowerCase().includes('snow') && "from-blue-200 to-blue-400",
                weather.description.toLowerCase().includes('thunder') && "from-purple-600 to-indigo-900",
                !weather.description.toLowerCase().includes('clear') && 
                !weather.description.toLowerCase().includes('cloud') && 
                !weather.description.toLowerCase().includes('rain') && 
                !weather.description.toLowerCase().includes('snow') && 
                !weather.description.toLowerCase().includes('thunder') && "from-blue-500 to-purple-600"
            );

            return (
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div className="lg:col-span-2">
                        <Card className={cn("h-80 overflow-hidden", gradientClass)}>
                            <div className="p-8 h-full flex flex-col justify-between text-white relative">
                                <div className="absolute inset-0 opacity-10">
                                    <div className="absolute top-10 right-10 text-8xl">
                                        {getWeatherIcon(weather.description)}
                                    </div>
                                </div>
                                
                                <div className="relative z-10">
                                    <div className="space-y-2 mb-6">
                                        <h2 className="text-lg font-medium text-white/90">
                                            {weather.location}, {weather.country}
                                        </h2>
                                        <div className="flex items-baseline gap-2">
                                            <span className="text-7xl font-thin">
                                                {formatTemperature(weather.temperature)}
                                            </span>
                                            <span className="text-3xl text-white/70">
                                                {getWeatherIcon(weather.description)}
                                            </span>
                                        </div>
                                        <p className="text-xl font-medium text-white/90 capitalize">
                                            {weather.description}
                                        </p>
                                    </div>
                                </div>
                                
                                <div className="relative z-10">
                                    <div className="flex items-center justify-between text-sm text-white/80">
                                        <span>Feels like {formatTemperature(weather.feels_like)}</span>
                                        <span>Updated: {new Date(weather.last_updated).toLocaleTimeString()}</span>
                                    </div>
                                </div>
                            </div>
                        </Card>
                    </div>
                    
                    <div>
                        <Card className="h-80 bg-gray-50/50 backdrop-blur-sm border-0 overflow-hidden">
                            <div className="p-6 h-full">
                                <h3 className="text-lg font-semibold mb-4 text-gray-800">Weather Details</h3>
                                <div className="space-y-3">
                                    <WeatherDetailItem icon="üíß" label="Humidity" value={weather.humidity} unit="%" />
                                    <WeatherDetailItem icon="üå°Ô∏è" label="Pressure" value={weather.pressure} unit=" hPa" />
                                    <WeatherDetailItem icon="üí®" label="Wind Speed" value={weather.wind_speed} unit=" m/s" />
                                    <WeatherDetailItem icon="üëÅÔ∏è" label="Visibility" value={weather.visibility} unit={typeof weather.visibility === 'number' ? ' km' : ''} />
                                    <WeatherDetailItem icon="‚òÄÔ∏è" label="UV Index" value={weather.uv_index} />
                                </div>
                            </div>
                        </Card>
                    </div>
                </div>
            );
        };

        // Home Tab Component - Weather Dashboard Style
        const HomeTab = ({ onTabChange, tabState, updateTabState }) => {
            const { weather, loading, error, searchLocation } = tabState;
            const [searchInput, setSearchInput] = useState(searchLocation);
            const [hasInitialized, setHasInitialized] = useState(false);

            const fetchWeatherData = async (location = searchLocation) => {
                try {
                    updateTabState({ loading: true, error: null });
                    const url = location && location !== 'Ho Chi Minh City' 
                        ? `/api/weather/current?location=${encodeURIComponent(location)}`
                        : '/api/weather/current';
                    
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (response.ok && !data.error) {
                        updateTabState({ 
                            weather: data, 
                            loading: false, 
                            error: null,
                            searchLocation: location 
                        });
                    } else {
                        // Check for specific API rate limit errors
                        const errorMessage = data.error || data.Message || 'Failed to fetch weather data';
                        if (errorMessage.includes('exceeded') || errorMessage.includes('ServiceUnavailable') || data.Code === 'ServiceUnavailable') {
                            updateTabState({ loading: false, error: 'API_RATE_LIMIT' });
                        } else {
                            updateTabState({ loading: false, error: errorMessage });
                        }
                    }
                } catch (err) {
                    console.error('Error fetching weather data:', err);
                    updateTabState({ loading: false, error: 'Failed to fetch weather data' });
                }
            };

            useEffect(() => {
                // Only fetch weather data on initial load if we don't have it yet
                if (!hasInitialized && !weather && !error && !loading) {
                    setHasInitialized(true);
                    fetchWeatherData();
                }
            }, [hasInitialized, weather, error, loading]);

            const handleSearch = (e) => {
                e.preventDefault();
                if (searchInput.trim()) {
                    fetchWeatherData(searchInput.trim());
                }
            };

            const handleRefresh = () => {
                fetchWeatherData(searchLocation);
            };

            if (loading) {
                return (
                    <div className="text-white p-6">
                        <div className="max-w-7xl mx-auto">
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-pulse">
                                <div className="lg:col-span-2 space-y-6">
                                    <div className="bg-slate-700 rounded-3xl h-80"></div>
                                    <div className="grid grid-cols-3 gap-4">
                                        <div className="bg-slate-700 rounded-2xl h-32"></div>
                                        <div className="bg-slate-700 rounded-2xl h-32"></div>
                                        <div className="bg-slate-700 rounded-2xl h-32"></div>
                                    </div>
                                </div>
                                <div className="bg-slate-700 rounded-3xl h-96"></div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (error || !weather) {
                return (
                    <div className="text-white p-6">
                        <div className="max-w-7xl mx-auto flex items-center justify-center min-h-96">
                            <div className="text-center">
                                <div className="text-6xl mb-4">
                                    {error === 'API_RATE_LIMIT' ? 'üö´' : '‚ö†Ô∏è'}
                                </div>
                                <h3 className="text-xl font-semibold mb-2">
                                    {error === 'API_RATE_LIMIT' 
                                        ? 'API Usage Limit Reached' 
                                        : 'Weather Data Unavailable'}
                                </h3>
                                <p className="text-slate-400 mb-4">
                                    {error === 'API_RATE_LIMIT' 
                                        ? 'The AccuWeather API daily limit has been exceeded. Consider using your own API Key to continue the service.'
                                        : 'Unable to fetch current weather data. Please check your API settings.'}
                                </p>
                                {error === 'API_RATE_LIMIT' ? (
                                    <div className="bg-slate-800/50 rounded-lg p-4 max-w-md mx-auto">
                                        <p className="text-sm text-slate-300">
                                            <strong>Daily Limit:</strong> 50 calls per day<br/>
                                            <strong>Reset Time:</strong> Midnight UTC
                                        </p>
                                    </div>
                                ) : (
                                    <Button onClick={() => onTabChange('settings')} variant="outline">
                                        Check API Settings
                                    </Button>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            const forecastData = [
                { day: 'Tuesday', date: '25 July', icon: '‚õÖ', temp: '+29¬∞', low: '+15' },
                { day: 'Wednesday', date: '26 July', icon: '‚õÖ', temp: '+31¬∞', low: '+16' },
                { day: 'Thursday', date: '27 July', icon: '‚õÖ', temp: '+34¬∞', low: '+20' },
                { day: 'Friday', date: '28 July', icon: 'üåßÔ∏è', temp: '+30¬∞', low: '+17' },
            ];

            const getTimeBasedGradient = () => {
                const hour = new Date().getHours();
                if (hour >= 6 && hour < 12) {
                    return "from-orange-400 via-yellow-400 to-yellow-300"; // Morning
                } else if (hour >= 12 && hour < 18) {
                    return "from-blue-400 via-cyan-400 to-blue-300"; // Afternoon
                } else if (hour >= 18 && hour < 20) {
                    return "from-orange-500 via-red-400 to-pink-400"; // Evening
                } else {
                    return "from-indigo-500 via-purple-500 to-pink-500"; // Night
                }
            };

            return (
                <div className="text-white p-6">
                    <div className="max-w-7xl mx-auto space-y-6">
                        {/* Search and Refresh Controls */}
                        <div className="flex flex-col sm:flex-row gap-4 items-center justify-between mb-6">
                            <div className="flex-1 max-w-md">
                                <form onSubmit={handleSearch} className="flex gap-2">
                                    <input
                                        type="text"
                                        value={searchInput}
                                        onChange={(e) => setSearchInput(e.target.value)}
                                        placeholder="Search location (e.g., London, Paris, Tokyo)"
                                        className="flex-1 px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    />
                                    <button
                                        type="submit"
                                        disabled={loading}
                                        className="px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-white rounded-lg transition-colors flex items-center gap-2"
                                    >
                                        Search
                                    </button>
                                </form>
                            </div>
                            <div className="flex items-center gap-3">
                                <span className="text-sm text-slate-400">Current: {searchLocation}</span>
                                <button
                                    onClick={handleRefresh}
                                    disabled={loading}
                                    className="px-4 py-2 bg-slate-700 hover:bg-slate-600 disabled:opacity-50 disabled:cursor-not-allowed text-white rounded-lg transition-colors flex items-center gap-2"
                                >
                                    Refresh
                                </button>
                            </div>
                        </div>

                        {/* Main Layout */}
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            {/* Left Side - Main Weather & Metrics */}
                            <div className="lg:col-span-2 space-y-6">
                                {/* Main Weather Card - Bigger and More Visible */}
                                <div className={`relative overflow-hidden rounded-3xl bg-gradient-to-br ${getTimeBasedGradient()} p-10 h-96 shadow-2xl border border-white/20`}>
                                    <div className="relative z-10 h-full flex flex-col justify-between">
                                        <div>
                                            <div className="flex items-center justify-between mb-8">
                                                <div>
                                                    <div className="text-8xl font-thin mb-4">{formatTemperature(weather.temperature)}</div>
                                                    <div className="text-xl font-medium capitalize">{weather.description}</div>
                                                </div>
                                                <div className="text-9xl opacity-60">
                                                    {getWeatherIcon(weather.description)}
                                                </div>
                                            </div>
                                        </div>
                                        <div>
                                            <div className="flex items-center gap-2 mb-3">
                                                <span className="text-base">üìç</span>
                                                <span className="text-base font-medium">{weather.location}, {weather.country}</span>
                                            </div>
                                            <div className="text-base opacity-90">
                                                {new Date(weather.last_updated).toLocaleDateString('en-US', { 
                                                    weekday: 'long', 
                                                    month: 'long', 
                                                    day: 'numeric',
                                                    hour: '2-digit',
                                                    minute: '2-digit'
                                                })}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Today's Highlights */}
                                <div>
                                    <h3 className="text-lg font-medium mb-4 text-slate-300">Today's Highlights</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        {/* Wind Status */}
                                        <div className="bg-slate-800/90 rounded-2xl p-6 border border-slate-600 shadow-lg">
                                            <div className="text-sm text-slate-300 mb-2 font-medium">Wind Status</div>
                                            <div className="text-2xl font-semibold mb-3 text-white">{weather.wind_speed} <span className="text-sm text-slate-300">km/h</span></div>
                                            <div className="w-full bg-slate-600 rounded-full h-2">
                                                <div className="bg-cyan-400 h-2 rounded-full" style={{width: `${Math.min(weather.wind_speed * 2, 100)}%`}}></div>
                                            </div>
                                        </div>

                                        {/* UV Index */}
                                        <div className="bg-slate-800/90 rounded-2xl p-6 border border-slate-600 shadow-lg">
                                            <div className="text-sm text-slate-300 mb-2 font-medium">UV Index</div>
                                            <div className="text-2xl font-semibold mb-3 text-white">{weather.uv_index} <span className="text-sm text-slate-300">UVI</span></div>
                                            <div className="flex justify-center items-center">
                                                <div className="relative w-20 h-20">
                                                    <svg className="w-20 h-20 transform -rotate-90" viewBox="0 0 36 36">
                                                        <path className="text-slate-600" strokeDasharray="75, 100" strokeWidth="3" fill="none" stroke="currentColor" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                                                        <path className="text-orange-400" strokeDasharray={`${weather.uv_index * 7.5}, 100`} strokeWidth="3" fill="none" stroke="currentColor" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>

                                        {/* AQI Index */}
                                        <div className="bg-slate-800/90 rounded-2xl p-6 border border-slate-600 shadow-lg">
                                            <div className="text-sm text-slate-300 mb-2 font-medium">AQI Index</div>
                                            <div className="text-2xl font-semibold mb-3 text-white">
                                                {weather.aqi_index} 
                                                <span className="text-sm text-slate-300 ml-1">
                                                    {weather.aqi_index <= 50 ? 'Good' : 
                                                     weather.aqi_index <= 100 ? 'Moderate' : 
                                                     weather.aqi_index <= 150 ? 'Unhealthy for Sensitive Groups' : 
                                                     weather.aqi_index <= 200 ? 'Unhealthy' : 
                                                     weather.aqi_index <= 300 ? 'Very Unhealthy' : 'Hazardous'}
                                                </span>
                                            </div>
                                            <div className="w-full bg-slate-600 rounded-full h-2">
                                                <div 
                                                    className={`h-2 rounded-full ${
                                                        weather.aqi_index <= 50 ? 'bg-green-400' : 
                                                        weather.aqi_index <= 100 ? 'bg-yellow-400' : 
                                                        weather.aqi_index <= 150 ? 'bg-orange-400' : 
                                                        weather.aqi_index <= 200 ? 'bg-red-400' : 
                                                        weather.aqi_index <= 300 ? 'bg-purple-400' : 'bg-red-600'
                                                    }`}
                                                    style={{width: `${Math.min(weather.aqi_index / 5, 100)}%`}}
                                                ></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Additional Metrics */}
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    {/* Humidity */}
                                    <div className="bg-slate-800/90 rounded-2xl p-6 border border-slate-600 shadow-lg">
                                        <div className="text-sm text-slate-300 mb-2 font-medium">Humidity</div>
                                        <div className="text-2xl font-semibold text-white">{weather.humidity}%</div>
                                        <div className="text-xs text-slate-400 mt-1">The dew point is {weather.dew_point}¬∞ right now</div>
                                    </div>

                                    {/* Visibility */}
                                    <div className="bg-slate-800/90 rounded-2xl p-6 border border-slate-600 shadow-lg">
                                        <div className="text-sm text-slate-300 mb-2 font-medium">Visibility</div>
                                        <div className="text-2xl font-semibold text-white">{weather.visibility} <span className="text-sm text-slate-300">km</span></div>
                                        <div className="text-xs text-slate-400 mt-1">Haze is affecting visibility</div>
                                    </div>

                                    {/* Feels Like */}
                                    <div className="bg-slate-800/90 rounded-2xl p-6 border border-slate-600 shadow-lg">
                                        <div className="text-sm text-slate-300 mb-2 font-medium">Feels Like</div>
                                        <div className="text-2xl font-semibold text-white">{formatTemperature(weather.feels_like)}</div>
                                        <div className="text-xs text-slate-400 mt-1">Humidity is making it feel hotter</div>
                                    </div>
                                </div>
                            </div>

                            {/* Right Side - 7 Day Forecast */}
                            <div className="bg-slate-800/90 rounded-3xl p-6 border border-slate-600 shadow-lg">
                                <div className="flex items-center justify-between mb-6">
                                    <h3 className="text-lg font-medium">5 days Forecast</h3>
                                    <select className="bg-slate-700 text-white text-sm rounded-lg px-3 py-1 border border-slate-600">
                                        <option>AccuWeather - 5 days</option>
                                    </select>
                                </div>

                                <div className="space-y-4">
                                    {forecastData.map((day, index) => (
                                        <div key={index} className="flex items-center justify-between py-3 border-b border-slate-700/50 last:border-b-0">
                                            <div className="flex items-center gap-4">
                                                <div className="text-2xl">{day.icon}</div>
                                                <div>
                                                    <div className="text-sm font-medium">{day.temp}<span className="text-slate-400">/{day.low}</span></div>
                                                    <div className="text-xs text-slate-400">{day.date}</div>
                                                </div>
                                            </div>
                                            <div className="text-right">
                                                <div className="text-sm text-slate-300">{day.day}</div>
                                            </div>
                                        </div>
                                    ))}

                                    <div className="mt-6 p-4 bg-slate-700/50 rounded-2xl">
                                        <div className="flex items-center gap-3 mb-3">
                                            <span className="text-2xl">üå§Ô∏è</span>
                                            <div>
                                                <div className="text-sm font-medium">Tomorrow</div>
                                                <div className="text-xs text-slate-400">Thunder Storm day</div>
                                            </div>
                                        </div>
                                        <div className="text-2xl font-bold">23¬∞</div>
                                        <div className="text-xs text-slate-400 mt-2">‚ö° Thunder Storm day</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Data Tab Component
        const DataTab = ({ tabState, updateTabState }) => {
            const { 
                analysis, loading, showNotebook, selectedOption,
                selectedFile, searchLocation, searchDays, isDragOver,
                showColumnRemover, selectedColumns, columnSearchTerm, showColumnDropdown,
                outlierHandlingDecision, columnRemovalDecision, columnRemovalCompleted,
                negativeValueHandlingDecision, negativeValueInfo,
                selectedAreaFeatures, showAreaFeatureDropdown, areaPlotData, loadingAreaPlot
            } = tabState;
            
            // Helper functions to update persistent state
            const setSelectedFile = (file) => updateTabState({ selectedFile: file });
            const setSearchLocation = (location) => updateTabState({ searchLocation: location });
            const setSearchDays = (days) => updateTabState({ searchDays: days });
            const setIsDragOver = (over) => updateTabState({ isDragOver: over });
            const setShowColumnRemover = (show) => updateTabState({ showColumnRemover: show });
            const setSelectedColumns = (columns) => updateTabState({ selectedColumns: columns });
            const setColumnSearchTerm = (term) => updateTabState({ columnSearchTerm: term });
            const setShowColumnDropdown = (show) => updateTabState({ showColumnDropdown: show });
            const setOutlierHandlingDecision = (decision) => updateTabState({ outlierHandlingDecision: decision });
            const setColumnRemovalDecision = (decision) => updateTabState({ columnRemovalDecision: decision });
            const setColumnRemovalCompleted = (completed) => updateTabState({ columnRemovalCompleted: completed });
            const setNegativeValueHandlingDecision = (decision) => updateTabState({ negativeValueHandlingDecision: decision });
            const setNegativeValueInfo = (info) => updateTabState({ negativeValueInfo: info });
            const setSelectedAreaFeatures = (features) => updateTabState({ selectedAreaFeatures: features });
            const setShowAreaFeatureDropdown = (show) => updateTabState({ showAreaFeatureDropdown: show });
            const setAreaPlotData = (data) => updateTabState({ areaPlotData: data });
            const setLoadingAreaPlot = (loading) => updateTabState({ loadingAreaPlot: loading });
            
            const dropdownRef = useRef(null);
            const areaDropdownRef = useRef(null);

            // Add click outside functionality for dropdown
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                        setShowColumnDropdown(false);
                    }
                    if (areaDropdownRef.current && !areaDropdownRef.current.contains(event.target)) {
                        setShowAreaFeatureDropdown(false);
                    }
                };

                if (showColumnDropdown || showAreaFeatureDropdown) {
                    document.addEventListener('mousedown', handleClickOutside);
                    return () => {
                        document.removeEventListener('mousedown', handleClickOutside);
                    };
                }
            }, [showColumnDropdown, showAreaFeatureDropdown]);

            // Check for negative values when analysis is loaded and column removal is completed
            useEffect(() => {
                if (analysis && columnRemovalCompleted) {
                    checkNegativeValues();
                }
            }, [analysis, columnRemovalCompleted]);

            const handleOptionSelect = (option) => {
                // Only clear analysis if switching to a different option
                const shouldClearAnalysis = selectedOption !== option;
                updateTabState({ 
                    selectedOption: option,
                    analysis: shouldClearAnalysis ? null : analysis,
                    showNotebook: false
                });
            };

            const handleFileSelect = (event) => {
                const file = event.target.files?.[0];
                if (file && file.type === 'text/csv') {
                    setSelectedFile(file);
                } else {
                    alert('Please select a CSV file');
                }
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                setIsDragOver(true);
            };

            const handleDragLeave = (e) => {
                e.preventDefault();
                setIsDragOver(false);
            };

            const handleDrop = (e) => {
                e.preventDefault();
                setIsDragOver(false);
                const file = e.dataTransfer.files[0];
                if (file && file.type === 'text/csv') {
                    setSelectedFile(file);
                } else {
                    alert('Please select a CSV file');
                }
            };

            const handleUpload = async () => {
                if (!selectedFile) return;

                // Don't re-upload if we already have analysis for uploaded dataset  
                if (analysis && selectedOption === 'upload' && selectedFile.name === analysis.filename) {
                    return;
                }

                const formData = new FormData();
                formData.append('file', selectedFile);

                try {
                    updateTabState({ loading: true, showNotebook: false });
                    setOutlierHandlingDecision(null); // Reset outlier handling decision
                    setColumnRemovalDecision(null); // Reset column removal decision
                    setColumnRemovalCompleted(false); // Reset completion status
                    setNegativeValueHandlingDecision(null); // Reset negative value handling
                    setNegativeValueInfo(null); // Reset negative value info
                    const response = await fetch('/upload-dataset', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();
                    if (data.success) {
                        updateTabState({ 
                            analysis: data.analysis, 
                            loading: false, 
                            showNotebook: false 
                        });
                    } else {
                        alert(data.error);
                        updateTabState({ loading: false });
                    }
                } catch (error) {
                    console.error('Error uploading dataset:', error);
                    alert('Error uploading dataset');
                    updateTabState({ loading: false });
                }
            };

            const handleUseDefault = async () => {
                // Don't re-fetch if we already have analysis and the option hasn't changed
                if (analysis && selectedOption === 'default') {
                    return;
                }
                
                try {
                    updateTabState({ loading: true, analysis: null, showNotebook: false });
                    setOutlierHandlingDecision(null); // Reset outlier handling decision
                    setColumnRemovalDecision(null); // Reset column removal decision
                    setColumnRemovalCompleted(false); // Reset completion status
                    setNegativeValueHandlingDecision(null); // Reset negative value handling
                    setNegativeValueInfo(null); // Reset negative value info
                    const response = await fetch('/api/data-analysis/default');
                    const data = await response.json();
                    if (data.success) {
                        updateTabState({ 
                            analysis: data.analysis, 
                            loading: false, 
                            showNotebook: false 
                        });
                    } else {
                        alert(data.error);
                        updateTabState({ loading: false });
                    }
                } catch (error) {
                    console.error('Error loading default dataset:', error);
                    alert('Error loading default dataset');
                    updateTabState({ loading: false });
                }
            };

            const handleSearchData = async () => {
                if (!searchLocation.trim()) {
                    alert('Please enter a location name');
                    return;
                }

                // Don't re-fetch if we already have analysis for the same location and days
                if (analysis && selectedOption === 'search' && 
                    analysis.location === searchLocation.trim() && 
                    analysis.days === searchDays) {
                    return;
                }

                try {
                    updateTabState({ loading: true, analysis: null, showNotebook: false });
                    setOutlierHandlingDecision(null); // Reset outlier handling decision
                    setColumnRemovalDecision(null); // Reset column removal decision
                    setColumnRemovalCompleted(false); // Reset completion status
                    setNegativeValueHandlingDecision(null); // Reset negative value handling
                    setNegativeValueInfo(null); // Reset negative value info
                    const response = await fetch('/api/data-analysis/search', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            location: searchLocation.trim(),
                            days: searchDays
                        })
                    });
                    const data = await response.json();
                    if (data.success) {
                        updateTabState({ 
                            analysis: data.analysis, 
                            loading: false, 
                            showNotebook: false 
                        });
                    } else {
                        alert(data.error);
                        updateTabState({ loading: false });
                    }
                } catch (error) {
                    console.error('Error searching location data:', error);
                    alert('Error searching location data');
                    updateTabState({ loading: false });
                }
            };

            // Column removal functions
            const handleRemoveColumns = async () => {
                if (selectedColumns.length === 0) {
                    alert('Please select columns to remove');
                    return;
                }

                try {
                    updateTabState({ loading: true });
                    const response = await fetch('/api/data-analysis/remove-columns', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            columns_to_remove: selectedColumns,
                            dataset_type: selectedOption,
                            location: searchLocation,
                            days: searchDays
                        })
                    });
                    const data = await response.json();
                    if (data.success) {
                        updateTabState({ 
                            analysis: data.analysis, 
                            loading: false 
                        });
                        setSelectedColumns([]);
                        setShowColumnRemover(false);
                        setColumnRemovalCompleted(true); // Mark completion when removal is done
                        if (data.removed_columns.length > 0) {
                            alert(`Successfully removed columns: ${data.removed_columns.join(', ')}`);
                        }
                    } else {
                        alert(data.error);
                        updateTabState({ loading: false });
                    }
                } catch (error) {
                    console.error('Error removing columns:', error);
                    alert('Error removing columns');
                    updateTabState({ loading: false });
                }
            };

            const toggleColumnSelection = (column) => {
                const isSelected = selectedColumns.includes(column);
                if (isSelected) {
                    setSelectedColumns(selectedColumns.filter(col => col !== column));
                } else {
                    setSelectedColumns([...selectedColumns, column]);
                }
            };

            const removeSelectedColumn = (column) => {
                setSelectedColumns(selectedColumns.filter(col => col !== column));
            };

            const handleOutlierTreatment = async (method) => {
                if (!analysis) return;
                
                updateTabState({ loading: true });
                
                try {
                    const response = await fetch(`/api/outlier-handling/${method}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            dataset_type: selectedOption,
                            location: searchLocation,
                            days: searchDays
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        updateTabState({ 
                            analysis: data.analysis,
                            loading: false 
                        });
                        setOutlierHandlingDecision(method);
                        alert(`Successfully applied ${method} outlier treatment`);
                    } else {
                        alert(data.error || `Failed to apply ${method} treatment`);
                        updateTabState({ loading: false });
                    }
                } catch (err) {
                    console.error(`Error applying ${method} treatment:`, err);
                    alert(`Error applying ${method} treatment`);
                    updateTabState({ loading: false });
                }
            };

            // Negative value handling functionality
            const checkNegativeValues = async () => {
                try {
                    const response = await fetch('/api/check-negative-values', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            dataset_type: selectedOption,
                            location: searchLocation,
                            days: searchDays
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        setNegativeValueInfo(data);
                    } else {
                        console.error('Error checking negative values:', data.error);
                    }
                } catch (err) {
                    console.error('Error checking negative values:', err);
                }
            };

            const handleNegativeValueTreatment = async (method) => {
                updateTabState({ loading: true });
                try {
                    const response = await fetch('/api/handle-negative-values', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            method: method,
                            dataset_type: selectedOption,
                            location: searchLocation,
                            days: searchDays
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        updateTabState({ 
                            analysis: data.analysis,
                            loading: false 
                        });
                        setNegativeValueHandlingDecision(method);
                        alert(`Successfully applied ${method} negative value treatment`);
                    } else {
                        alert(data.error || `Failed to apply ${method} treatment`);
                        updateTabState({ loading: false });
                    }
                } catch (err) {
                    console.error(`Error applying ${method} treatment:`, err);
                    alert(`Error applying ${method} treatment`);
                    updateTabState({ loading: false });
                }
            };

            // Area plot functionality
            const getAvailableFeatures = () => {
                if (!analysis || !analysis.dtypes) return [];
                return Object.keys(analysis.dtypes).filter(col => 
                    analysis.dtypes[col] === 'int64' || analysis.dtypes[col] === 'float64'
                );
            };

            const toggleAreaFeatureSelection = (feature) => {
                const isSelected = selectedAreaFeatures.includes(feature);
                if (isSelected) {
                    setSelectedAreaFeatures(selectedAreaFeatures.filter(f => f !== feature));
                } else {
                    setSelectedAreaFeatures([...selectedAreaFeatures, feature]);
                }
            };

            const removeSelectedAreaFeature = (feature) => {
                setSelectedAreaFeatures(selectedAreaFeatures.filter(f => f !== feature));
            };

            const generateAreaPlot = async () => {
                if (selectedAreaFeatures.length === 0) {
                    alert('Please select at least one feature to visualize');
                    return;
                }

                setLoadingAreaPlot(true);
                try {
                    const response = await fetch('/api/area-plot', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            features: selectedAreaFeatures,
                            dataset_type: selectedOption,
                            location: searchLocation,
                            days: searchDays,
                            outlier_handling: outlierHandlingDecision
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        setAreaPlotData(data.plot_data);
                    } else {
                        alert(data.error || 'Failed to generate area plot');
                    }
                } catch (err) {
                    console.error('Error generating area plot:', err);
                    alert('Error generating area plot');
                } finally {
                    setLoadingAreaPlot(false);
                }
            };

            // Export raw dataset function
            const handleExportRawDataset = async () => {
                try {
                    const response = await fetch('/api/export-raw-dataset', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            dataset_type: selectedOption,
                            location: searchLocation,
                            days: searchDays
                        })
                    });

                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        
                        // Generate filename based on location and date range
                        const sanitizedLocation = searchLocation.replace(/[^a-zA-Z0-9]/g, '_');
                        const filename = `air_quality_${sanitizedLocation}_${searchDays}days_${new Date().toISOString().split('T')[0]}.csv`;
                        a.download = filename;
                        
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                    } else {
                        const errorData = await response.json();
                        alert(errorData.error || 'Failed to export dataset');
                    }
                } catch (err) {
                    console.error('Error exporting dataset:', err);
                    alert('Error exporting dataset');
                }
            };

            const getAvailableColumns = () => {
                if (!analysis || !analysis.dtypes) return [];
                
                const requiredColumns = ["co", "no", "no2", "o3", "so2", "pm2_5", "pm10", "nh3", "datetime", "aqi"];
                const availableColumns = analysis.dtypes
                    .map(col => col.column)
                    .filter(col => !requiredColumns.includes(col));
                
                return availableColumns.filter(col => 
                    col.toLowerCase().includes(columnSearchTerm.toLowerCase())
                );
            };

            const handleColumnKeyDown = (e) => {
                if (e.key === 'Enter' && getAvailableColumns().length > 0) {
                    const firstColumn = getAvailableColumns()[0];
                    if (!selectedColumns.includes(firstColumn)) {
                        toggleColumnSelection(firstColumn);
                    }
                    setColumnSearchTerm('');
                }
            };

            return (
                <div className="space-y-8">
                    <div className="text-center space-y-4">
                        <h2 className="text-3xl font-bold text-white">Air Quality Data Analysis</h2>
                        <p className="text-lg text-slate-300 max-w-2xl mx-auto">
                            Choose your data source and explore comprehensive air quality analysis with detailed insights
                        </p>
                    </div>

                    {/* Three Options */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        {/* Option 1: Use Default Dataset */}
                        <div className="bg-slate-800/50 backdrop-blur-sm rounded-3xl p-6 border border-slate-700/50 hover:border-blue-500/50 transition-colors">
                            <div className="space-y-4">
                                <div className="flex items-center gap-3 mb-4">
                                    <DatabaseIcon />
                                    <h3 className="text-xl font-semibold text-white">Use Default Dataset</h3>
                                </div>
                                <p className="text-slate-300 mb-6">
                                    Analyze our Ho Chi Minh City air quality data with comprehensive pollutant measurements
                                </p>
                                <Button 
                                    onClick={() => {
                                        handleOptionSelect('default');
                                        handleUseDefault();
                                    }}
                                    disabled={loading} 
                                    className="w-full bg-blue-600 hover:bg-blue-700 text-white"
                                >
                                    {loading && selectedOption === 'default' ? 'Analyzing...' : 'Use Default Dataset'}
                                </Button>
                            </div>
                        </div>

                        {/* Option 2: Search Location */}
                        <div className="bg-slate-800/50 backdrop-blur-sm rounded-3xl p-6 border border-slate-700/50 hover:border-green-500/50 transition-colors">
                            <div className="space-y-4">
                                <div className="flex items-center gap-3 mb-4">
                                    <svg className="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                    </svg>
                                    <h3 className="text-xl font-semibold text-white">Search Location</h3>
                                </div>
                                <p className="text-slate-300 mb-4">
                                    Fetch air quality data for any location with custom duration
                                </p>
                                <input
                                    type="text"
                                    value={searchLocation}
                                    onChange={(e) => setSearchLocation(e.target.value)}
                                    placeholder="Enter location name..."
                                    className="w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent mb-3"
                                />
                                <div className="flex gap-2 mb-4">
                                    <input
                                        type="number"
                                        value={searchDays}
                                        onChange={(e) => setSearchDays(Math.max(1, parseInt(e.target.value) || 30))}
                                        min="1"
                                        placeholder="Days"
                                        className="w-20 px-3 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                    />
                                    <span className="text-slate-300 self-center text-sm">days of data</span>
                                </div>
                                <Button 
                                    onClick={() => {
                                        handleOptionSelect('search');
                                        handleSearchData();
                                    }}
                                    disabled={loading || !searchLocation.trim()} 
                                    className="w-full bg-green-600 hover:bg-green-700 text-white"
                                >
                                    {loading && selectedOption === 'search' ? 'Searching...' : 'Search & Analyze'}
                                </Button>
                            </div>
                        </div>

                        {/* Option 3: Upload Dataset */}
                        <div className="bg-slate-800/50 backdrop-blur-sm rounded-3xl p-6 border border-slate-700/50 hover:border-purple-500/50 transition-colors">
                            <div className="space-y-4">
                                <div className="flex items-center gap-3 mb-4">
                                    <svg className="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                    </svg>
                                    <h3 className="text-xl font-semibold text-white">Upload Dataset</h3>
                                </div>
                                <p className="text-slate-300 mb-4">
                                    Upload your own CSV file for custom analysis
                                </p>
                                <div 
                                    className={`w-full border-2 border-dashed rounded-lg p-6 text-center transition-colors ${
                                        isDragOver ? 'border-purple-500 bg-purple-500/10' : 'border-slate-600 hover:border-purple-500'
                                    }`}
                                    onDragOver={handleDragOver}
                                    onDragLeave={handleDragLeave}
                                    onDrop={handleDrop}
                                >
                                    <input
                                        type="file"
                                        accept=".csv"
                                        onChange={handleFileSelect}
                                        className="hidden"
                                        id="file-upload"
                                    />
                                    <label 
                                        htmlFor="file-upload" 
                                        className="cursor-pointer text-slate-300"
                                    >
                                        {selectedFile ? (
                                            <span className="text-green-400">üìÅ {selectedFile.name}</span>
                                        ) : (
                                            <span>üìÅ Drop CSV file here or click to browse</span>
                                        )}
                                    </label>
                                </div>
                                <Button 
                                    onClick={() => {
                                        handleOptionSelect('upload');
                                        handleUpload();
                                    }}
                                    disabled={loading || !selectedFile} 
                                    className="w-full bg-purple-600 hover:bg-purple-700 text-white"
                                >
                                    {loading && selectedOption === 'upload' ? 'Uploading...' : 'Upload & Analyze'}
                                </Button>
                            </div>
                        </div>
                    </div>

                    {showNotebook && (
                        <div className="space-y-6">
                            <div className="text-center space-y-2">
                                <h3 className="text-2xl font-bold text-white">Weather Data Analysis Notebook</h3>
                                <p className="text-slate-300">Interactive analysis and visualization of weather data patterns</p>
                            </div>
                            
                            <div className="bg-slate-800/50 backdrop-blur-sm rounded-3xl p-6 border border-slate-700/50">
                                <div className="space-y-4">
                                    <div className="flex items-center gap-3 mb-4">
                                        <DatabaseIcon />
                                        <h4 className="text-xl font-semibold text-white">Google Colab Notebook - Weather Data Analysis</h4>
                                    </div>
                                    <p className="text-slate-300 mb-6">
                                        Explore weather patterns, perform statistical analysis, and create visualizations
                                    </p>
                                    <div className="w-full h-[800px] border-2 border-slate-600 rounded-lg overflow-hidden">
                                        <iframe
                                            src="/notebook"
                                            width="100%"
                                            height="100%"
                                            className="border-0"
                                            title="Weather Data Analysis Notebook"
                                        />
                                    </div>
                                    
                                </div>
                            </div>
                        </div>
                    )}

                    {analysis && (
                        <div className="space-y-8">
                            {/* Export Raw Dataset Option for Search Location */}
                            {selectedOption === 'search' && (
                                <div className="bg-gradient-to-r from-green-900/30 to-emerald-900/30 backdrop-blur-sm rounded-2xl p-6 border border-green-700/50">
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center gap-3">
                                            <svg className="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                            </svg>
                                            <div>
                                                <h4 className="text-lg font-semibold text-white">Export Raw Dataset</h4>
                                                <p className="text-sm text-green-200">
                                                    Download the fetched air quality data for {searchLocation} ({searchDays} days) as CSV
                                                </p>
                                            </div>
                                        </div>
                                        <Button
                                            onClick={handleExportRawDataset}
                                            className="bg-green-600 hover:bg-green-700 text-white flex items-center gap-2"
                                        >
                                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                            </svg>
                                            Export CSV
                                        </Button>
                                    </div>
                                </div>
                            )}
                            
                            <div className="text-center">
                                <h3 className="text-2xl font-bold text-white mb-2">Dataset Analysis Results</h3>
                                <p className="text-slate-300">Comprehensive insights from your weather data</p>
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                                <div className="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-6 border border-slate-700/50">
                                    <div className="text-sm text-slate-400 mb-2">Dataset Size</div>
                                    <div className="text-2xl font-bold text-blue-400">
                                        {analysis.shape[0].toLocaleString()}
                                    </div>
                                    <div className="text-sm text-slate-500">
                                        rows √ó {analysis.shape[1]} columns
                                    </div>
                                </div>

                                <div className="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-6 border border-slate-700/50">
                                    <div className="text-sm text-slate-400 mb-2">Dataset Duration</div>
                                    <div className="text-2xl font-bold text-green-400">
                                        {analysis.dataset_days} {analysis.dataset_days === 1 ? 'Day' : 'Days'}
                                    </div>
                                    <div className="text-sm text-slate-500">
                                        Time span covered
                                    </div>
                                </div>

                                <div className="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-6 border border-slate-700/50">
                                    <div className="text-sm text-slate-400 mb-2">Missing Values</div>
                                    <div className="text-2xl font-bold text-orange-400">
                                        {Object.values(analysis.missing_values).reduce((sum, val) => sum + val, 0)}
                                    </div>
                                    <div className="text-sm text-slate-500">
                                        Total missing entries
                                    </div>
                                </div>

                                <div className="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-6 border border-slate-700/50">
                                    <div className="text-sm text-slate-400 mb-2">Duplicates</div>
                                    <div className="text-2xl font-bold text-red-400">
                                        {analysis.duplicate_rows}
                                    </div>
                                    <div className="text-sm text-slate-500">
                                        Duplicate rows found
                                    </div>
                                </div>
                            </div>

                            {/* Column Information Table */}
                            <div className="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-6 border border-slate-700/50">
                                <div className="flex items-center gap-2 mb-6">
                                    <svg className="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                    <h4 className="text-lg font-semibold text-white">Column Information</h4>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead>
                                            <tr className="border-b border-slate-600">
                                                <th className="text-left py-2 px-3 text-slate-300">Column</th>
                                                <th className="text-left py-2 px-3 text-slate-300">Data Type</th>
                                                <th className="text-left py-2 px-3 text-slate-300">Non-Null Count</th>
                                                <th className="text-left py-2 px-3 text-slate-300">Null Count</th>
                                                <th className="text-left py-2 px-3 text-slate-300">Unique Values</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {analysis.dtypes.map((col, index) => (
                                                <tr key={index} className="border-b border-slate-700/50">
                                                    <td className="py-2 px-3 font-medium text-white">{col.column}</td>
                                                    <td className="py-2 px-3">
                                                        <span className="px-2 py-1 bg-blue-600/80 text-blue-100 text-xs rounded">
                                                            {col.dtype}
                                                        </span>
                                                    </td>
                                                    <td className="py-2 px-3 text-slate-300">{col.non_null_count.toLocaleString()}</td>
                                                    <td className="py-2 px-3 text-slate-300">{col.null_count.toLocaleString()}</td>
                                                    <td className="py-2 px-3 text-slate-300">{col.unique_values.toLocaleString()}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            {/* Column Removal Feature */}
                            {analysis && analysis.dtypes && getAvailableColumns().length > 0 && (
                                <div className="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-6 border border-slate-700/50">
                                    <div className="flex items-center gap-2 mb-6">
                                        <svg className="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                        <h4 className="text-lg font-semibold text-white">Remove Columns</h4>
                                    </div>
                                    
                                    <div className="space-y-4">
                                        <p className="text-slate-300 text-sm">
                                            Remove unnecessary columns from your dataset. Required air quality columns cannot be removed.
                                        </p>
                                        
                                        <div className="space-y-3">
                                            <label className="block text-sm font-medium text-slate-300">Columns to Remove</label>
                                            <div className="relative dropdown-container" style={{ zIndex: 100 }} ref={dropdownRef}>
                                                <div
                                                    className="min-h-[48px] p-3 bg-slate-700 border border-slate-600 rounded-lg cursor-text flex flex-wrap gap-2 items-center"
                                                    onClick={() => setShowColumnDropdown(true)}
                                                >
                                                    {selectedColumns.map(column => (
                                                        <span
                                                            key={column}
                                                            className="bg-red-600 text-white px-2 py-1 rounded text-sm flex items-center gap-1 cursor-pointer"
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                toggleColumnSelection(column);
                                                            }}
                                                        >
                                                            {column}
                                                            <span className="text-xs">√ó</span>
                                                        </span>
                                                    ))}
                                                    <input
                                                        type="text"
                                                        value={columnSearchTerm}
                                                        onChange={(e) => {
                                                            setColumnSearchTerm(e.target.value);
                                                            setShowColumnDropdown(true);
                                                        }}
                                                        onKeyDown={handleColumnKeyDown}
                                                        onFocus={() => setShowColumnDropdown(true)}
                                                        placeholder={selectedColumns.length > 0 ? "" : "Type to search columns..."}
                                                        className="bg-transparent border-none outline-none text-white placeholder-slate-400 flex-1 min-w-0"
                                                    />
                                                </div>
                                                
                                                {showColumnDropdown && (
                                                    <div className="absolute top-full left-0 right-0 bg-slate-700 border border-slate-600 rounded-lg shadow-lg max-h-48 overflow-y-auto mt-1">
                                                        {getAvailableColumns().map(column => (
                                                            <div
                                                                key={column}
                                                                className="p-3 hover:bg-slate-600 cursor-pointer text-white"
                                                                onClick={() => toggleColumnSelection(column)}
                                                            >
                                                                {column}
                                                            </div>
                                                        ))}
                                                        {getAvailableColumns().length === 0 && (
                                                            <div className="p-3 text-slate-400">No available columns</div>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                        
                                        <div className="flex gap-3">
                                            <Button
                                                onClick={() => {
                                                    setNegativeValueInfo(null); // Reset negative value info before removal
                                                    handleRemoveColumns();
                                                    setColumnRemovalDecision('removed');
                                                }}
                                                disabled={loading || selectedColumns.length === 0}
                                                className="bg-red-600 hover:bg-red-700 text-white"
                                            >
                                                {loading ? 'Removing...' : 'Remove Selected Columns'}
                                            </Button>
                                            <Button
                                                onClick={() => {
                                                    setNegativeValueInfo(null); // Reset negative value info
                                                    setColumnRemovalDecision('none');
                                                    setColumnRemovalCompleted(true);
                                                }}
                                                className="bg-gray-600 hover:bg-gray-700 text-white"
                                            >
                                                Do Nothing
                                            </Button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Summary Statistics Table - Only show after column removal is completed */}
                            {columnRemovalCompleted && Object.keys(analysis.summary_stats).length > 0 && (
                                <div className="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-6 border border-slate-700/50">
                                    <div className="flex items-center gap-2 mb-6">
                                        <svg className="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                        </svg>
                                        <h4 className="text-lg font-semibold text-white">Summary Statistics</h4>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-sm">
                                            <thead>
                                                <tr className="border-b border-slate-600">
                                                    <th className="text-left py-2 px-3 text-slate-300">Statistic</th>
                                                    {Object.keys(analysis.summary_stats).map(col => (
                                                        <th key={col} className="text-left py-2 px-3 text-slate-300">{col}</th>
                                                    ))}
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {['count', 'mean', 'std', 'min', 'q25', 'median', 'q75', 'max', 'skewness', 'kurtosis'].map(stat => (
                                                    <tr key={stat} className="border-b border-slate-700/50">
                                                        <td className="py-2 px-3 font-medium text-white capitalize">{stat === 'q25' ? '25%' : stat === 'q75' ? '75%' : stat === 'std' ? 'Std Dev' : stat}</td>
                                                        {Object.keys(analysis.summary_stats).map(col => (
                                                            <td key={col} className="py-2 px-3 text-slate-300">
                                                                {analysis.summary_stats[col][stat] !== undefined ? 
                                                                    (typeof analysis.summary_stats[col][stat] === 'number' ? 
                                                                        analysis.summary_stats[col][stat].toFixed(2) : 
                                                                        analysis.summary_stats[col][stat]) : 
                                                                    '-'}
                                                            </td>
                                                        ))}
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}

                            {/* Handle Negative Values Card - Only show when dataset contains negative values */}
                            {columnRemovalCompleted && negativeValueInfo && negativeValueInfo.has_negatives && (
                                <div className="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-6 border border-slate-700/50">
                                    <div className="flex items-center gap-2 mb-6">
                                        <svg className="w-5 h-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.082 16.5c-.77.833.192 2.5 1.732 2.5z" />
                                        </svg>
                                        <h4 className="text-lg font-semibold text-white">Handle Negative Values</h4>
                                    </div>
                                    
                                    {/* Negative Value Statistics */}
                                    <div className="bg-yellow-900/30 border border-yellow-500/50 rounded-lg p-4 mb-6">
                                        <div className="flex items-center gap-2 mb-3">
                                            <svg className="w-4 h-4 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                            <h5 className="text-yellow-300 font-semibold">Negative Values Detected</h5>
                                        </div>
                                        <p className="text-yellow-200 text-sm mb-3">
                                            Found {negativeValueInfo.total_negative_values} negative values in your dataset across {Object.keys(negativeValueInfo.negative_stats).length} columns.
                                        </p>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                            {Object.entries(negativeValueInfo.negative_stats).map(([col, stats]) => (
                                                <div key={col} className="text-sm">
                                                    <span className="text-yellow-100 font-medium">{col}:</span>
                                                    <span className="text-yellow-200 ml-2">{stats.count} values ({stats.percentage.toFixed(1)}%)</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    
                                    {/* Negative Value Handling Options */}
                                    <div className="space-y-4">
                                        <p className="text-slate-300 text-sm">
                                            Choose how to handle negative values in your dataset:
                                        </p>
                                        
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                            <Button
                                                onClick={() => handleNegativeValueTreatment('interpolation')}
                                                disabled={loading}
                                                className="bg-blue-600 hover:bg-blue-700 text-white"
                                            >
                                                Linear Interpolation
                                            </Button>
                                            <Button
                                                onClick={() => handleNegativeValueTreatment('deletion')}
                                                disabled={loading}
                                                className="bg-red-600 hover:bg-red-700 text-white"
                                            >
                                                Deletion
                                            </Button>
                                            <Button
                                                onClick={() => setNegativeValueHandlingDecision('none')}
                                                className="bg-gray-600 hover:bg-gray-700 text-white"
                                            >
                                                Do Nothing
                                            </Button>
                                        </div>
                                        
                                        <div className="text-xs text-slate-400">
                                            <p><strong>Linear Interpolation:</strong> Replace negative values with interpolated values from surrounding data points</p>
                                            <p><strong>Deletion:</strong> Remove rows containing negative values</p>
                                            <p><strong>Do Nothing:</strong> Keep negative values unchanged</p>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Box Plot Analysis for Outlier Detection - Only show after negative value handling decision */}
                            {negativeValueHandlingDecision && analysis && analysis.box_plot_data && analysis.box_plot_data.plot && (
                                <div className="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-6 border border-slate-700/50">
                                    <div className="flex items-center gap-2 mb-6">
                                        <svg className="w-5 h-5 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" />
                                        </svg>
                                        <h4 className="text-lg font-semibold text-white">Outlier Detection & Handling</h4>
                                    </div>
                                    
                                    <div className="text-center mb-6">
                                        <img src={analysis.box_plot_data.plot.plot} alt="Box Plot for Outlier Detection" className="max-w-full h-auto mx-auto rounded-lg shadow-lg" />
                                    </div>
                                    
                                    {/* Outlier Statistics */}
                                    {analysis.box_plot_data.outlier_stats && Object.keys(analysis.box_plot_data.outlier_stats).length > 0 && (
                                        <div className="bg-slate-700/50 rounded-lg p-4 mb-6">
                                            <h5 className="text-white font-semibold mb-3">Outlier Statistics</h5>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                {Object.entries(analysis.box_plot_data.outlier_stats).map(([col, stats]) => (
                                                    <div key={col} className="text-sm">
                                                        <span className="text-white font-medium">{col}:</span>
                                                        <span className="text-orange-300 ml-2">{stats.count} outliers ({stats.percentage.toFixed(1)}%)</span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                    
                                    {/* Outlier Handling Options */}
                                    <div className="space-y-4">
                                        <p className="text-slate-300 text-sm">
                                            Choose how to handle outliers in your dataset:
                                        </p>
                                        
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                            <Button
                                                onClick={() => handleOutlierTreatment('capping')}
                                                disabled={loading}
                                                className="bg-blue-600 hover:bg-blue-700 text-white"
                                            >
                                                Capping
                                            </Button>

                                            <Button
                                                onClick={() => handleOutlierTreatment('deletion')}
                                                disabled={loading}
                                                className="bg-red-600 hover:bg-red-700 text-white"
                                            >
                                                Deletion
                                            </Button>
                                            <Button
                                                onClick={() => setOutlierHandlingDecision('none')}
                                                className="bg-gray-600 hover:bg-gray-700 text-white"
                                            >
                                                Do Nothing
                                            </Button>
                                        </div>
                                        
                                        <div className="text-xs text-slate-400">
                                            <p><strong>Capping:</strong> Replace outliers with boundary values</p>
                                            <p><strong>Deletion:</strong> Remove rows containing outliers</p>
                                            <p><strong>Do Nothing:</strong> Keep original data unchanged</p>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Export Modified Dataset Card - Only show after outlier handling decision */}
                            {outlierHandlingDecision && (
                                <div className="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-6 border border-slate-700/50">
                                    <div className="flex items-center gap-2 mb-6">
                                        <svg className="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                        </svg>
                                        <h4 className="text-lg font-semibold text-white">Export Modified Dataset</h4>
                                    </div>
                                    
                                    <div className="space-y-4">
                                        <p className="text-slate-300 text-sm">
                                            Download your processed dataset with all applied modifications (column removal, negative value handling, and outlier treatment).
                                        </p>
                                        
                                        {/* Dataset Status Info */}
                                        <div className="bg-slate-700/50 rounded-lg p-4">
                                            <div className="flex items-center gap-2 mb-2">
                                                <svg className="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                                <span className="text-white font-medium text-sm">Applied Modifications:</span>
                                            </div>
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-2 text-xs">
                                                <div className="text-slate-300">
                                                    <span className="font-medium">Columns:</span> {columnRemovalDecision === 'remove' ? 'Removed unwanted columns' : 'All columns retained'}
                                                </div>
                                                <div className="text-slate-300">
                                                    <span className="font-medium">Negative Values:</span> {negativeValueHandlingDecision === 'none' ? 'No treatment' : negativeValueHandlingDecision ? negativeValueHandlingDecision : 'Pending'}
                                                </div>
                                                <div className="text-slate-300">
                                                    <span className="font-medium">Outliers:</span> {outlierHandlingDecision === 'none' ? 'No treatment' : outlierHandlingDecision}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {/* Export Button */}
                                        <Button
                                            onClick={async () => {
                                                try {
                                                    const response = await fetch('/api/export-modified-dataset', {
                                                        method: 'POST',
                                                        headers: {
                                                            'Content-Type': 'application/json',
                                                        },
                                                        body: JSON.stringify({
                                                            dataset_type: selectedOption,
                                                            location: searchLocation,
                                                            days: searchDays
                                                        })
                                                    });
                                                    
                                                    if (response.ok) {
                                                        const blob = await response.blob();
                                                        const url = window.URL.createObjectURL(blob);
                                                        const a = document.createElement('a');
                                                        a.style.display = 'none';
                                                        a.href = url;
                                                        
                                                        // Get filename from response headers
                                                        const contentDisposition = response.headers.get('Content-Disposition');
                                                        let filename = 'modified_dataset.csv';
                                                        if (contentDisposition) {
                                                            const filenameMatch = contentDisposition.match(/filename="?([^"]+)"?/);
                                                            if (filenameMatch) {
                                                                filename = filenameMatch[1];
                                                            }
                                                        }
                                                        
                                                        a.download = filename;
                                                        document.body.appendChild(a);
                                                        a.click();
                                                        window.URL.revokeObjectURL(url);
                                                        document.body.removeChild(a);
                                                        
                                                        alert('Dataset exported successfully!');
                                                    } else {
                                                        const errorData = await response.json();
                                                        alert(errorData.error || 'Failed to export dataset');
                                                    }
                                                } catch (err) {
                                                    console.error('Error exporting dataset:', err);
                                                    alert('Error exporting dataset');
                                                }
                                            }}
                                            className="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 text-sm font-medium"
                                        >
                                            <div className="flex items-center justify-center gap-2">
                                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                                </svg>
                                                Download Modified Dataset (CSV)
                                            </div>
                                        </Button>
                                        
                                        <div className="text-xs text-slate-400">
                                            <p><strong>Note:</strong> The exported file includes all your data processing choices and will be timestamped with the current date and time.</p>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Advanced Visualizations Section - Only show after outlier handling decision */}
                            {analysis && analysis.visualizations && outlierHandlingDecision && (
                                <div className="space-y-6">
                                    <div className="text-center">
                                        <h3 className="text-2xl font-bold text-white mb-2">Advanced Statistical Visualizations</h3>
                                        <p className="text-slate-300">Comprehensive data analysis with correlation heatmaps and distribution plots</p>
                                        
                                        {outlierHandlingDecision !== 'none' && (
                                            <div className="bg-blue-900/30 border border-blue-500/50 rounded-lg p-4 mt-4 mx-auto max-w-2xl">
                                                <div className="flex items-center justify-center gap-2">
                                                    <svg className="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                    </svg>
                                                    <span className="text-blue-300 font-medium">
                                                        Visualizations updated with <span className="capitalize">{outlierHandlingDecision}</span> outlier treatment applied
                                                    </span>
                                                </div>
                                            </div>
                                        )}
                                        
                                        {outlierHandlingDecision === 'none' && (
                                            <div className="bg-gray-900/30 border border-gray-500/50 rounded-lg p-4 mt-4 mx-auto max-w-2xl">
                                                <div className="flex items-center justify-center gap-2">
                                                    <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                                    </svg>
                                                    <span className="text-gray-300 font-medium">
                                                        Visualizations display original raw dataset (no outlier treatment applied)
                                                    </span>
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    {/* Correlation Heatmap */}
                                    {analysis.visualizations.correlation_heatmap && (
                                        <div className="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-6 border border-slate-700/50">
                                            <div className="flex items-center gap-2 mb-6">
                                                <svg className="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                                </svg>
                                                <h4 className="text-lg font-semibold text-white">Correlation Heatmap</h4>
                                            </div>
                                            <div className="text-center">
                                                <img src={analysis.visualizations.correlation_heatmap} alt="Correlation Heatmap" className="max-w-full h-auto mx-auto rounded-lg shadow-lg" />
                                            </div>
                                        </div>
                                    )}

                                    {/* Word Cloud */}
                                    {analysis.visualizations.word_cloud && (
                                        <div className="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-6 border border-slate-700/50">
                                            <div className="flex items-center gap-2 mb-6">
                                                <svg className="w-5 h-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
                                                </svg>
                                                <h4 className="text-lg font-semibold text-white">Feature Names Word Cloud</h4>
                                            </div>
                                            <div className="text-center">
                                                <img src={analysis.visualizations.word_cloud} alt="Feature Names Word Cloud" className="max-w-full h-auto mx-auto rounded-lg shadow-lg" />
                                            </div>
                                        </div>
                                    )}

                                    {/* Area Plot */}
                                    <div className="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-6 border border-slate-700/50">
                                        <div className="flex items-center gap-2 mb-6">
                                            <svg className="w-5 h-5 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" />
                                            </svg>
                                            <h4 className="text-lg font-semibold text-white">Area Plot Visualization</h4>
                                        </div>
                                        
                                        <div className="space-y-4">
                                            <p className="text-slate-300 text-sm">
                                                Select features to visualize in an area chart showing trends over time.
                                            </p>
                                            
                                            {/* Feature Selection */}
                                            <div className="space-y-3">
                                                <label className="block text-sm font-medium text-slate-300">Features to Visualize</label>
                                                <div className="relative dropdown-container" style={{ zIndex: 99 }} ref={areaDropdownRef}>
                                                    <div
                                                        className="min-h-[48px] p-3 bg-slate-700 border border-slate-600 rounded-lg cursor-text flex flex-wrap gap-2 items-center"
                                                        onClick={() => setShowAreaFeatureDropdown(true)}
                                                    >
                                                        {selectedAreaFeatures.map(feature => (
                                                            <span
                                                                key={feature}
                                                                className="bg-cyan-600 text-white px-2 py-1 rounded text-sm flex items-center gap-1 cursor-pointer min-w-fit"
                                                                style={{ minWidth: 'fit-content' }}
                                                                onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    removeSelectedAreaFeature(feature);
                                                                }}
                                                            >
                                                                {feature}
                                                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                                                </svg>
                                                            </span>
                                                        ))}
                                                        <span className="text-slate-400 text-sm flex-1 min-w-0">
                                                            {selectedAreaFeatures.length === 0 ? "Click to select features..." : "Click to add more features..."}
                                                        </span>
                                                    </div>
                                                    
                                                    {showAreaFeatureDropdown && (
                                                        <div className="absolute top-full left-0 right-0 bg-slate-700 border border-slate-600 rounded-lg shadow-lg max-h-48 overflow-y-auto mt-1">
                                                            {getAvailableFeatures().map(feature => (
                                                                <div
                                                                    key={feature}
                                                                    className={`p-3 hover:bg-slate-600 cursor-pointer text-white ${selectedAreaFeatures.includes(feature) ? 'bg-slate-600' : ''}`}
                                                                    onClick={() => toggleAreaFeatureSelection(feature)}
                                                                >
                                                                    <div className="flex items-center justify-between">
                                                                        <span>{feature}</span>
                                                                        {selectedAreaFeatures.includes(feature) && (
                                                                            <svg className="w-4 h-4 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                                                                            </svg>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                            ))}
                                                            {getAvailableFeatures().length === 0 && (
                                                                <div className="p-3 text-slate-400">No numerical features available</div>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                            
                                            {/* Visualize Button */}
                                            <div className="flex gap-3">
                                                <Button
                                                    onClick={generateAreaPlot}
                                                    disabled={loadingAreaPlot || selectedAreaFeatures.length === 0}
                                                    className="bg-cyan-600 hover:bg-cyan-700 text-white"
                                                >
                                                    {loadingAreaPlot ? 'Generating...' : 'Visualize'}
                                                </Button>
                                                <Button
                                                    onClick={() => {
                                                        setSelectedAreaFeatures(['pm2_5', 'pm10']);
                                                        setShowAreaFeatureDropdown(false);
                                                    }}
                                                    className="bg-slate-600 hover:bg-slate-700 text-white"
                                                >
                                                    Reset to Default
                                                </Button>
                                            </div>
                                            
                                            {/* Area Plot Display */}
                                            {areaPlotData && (
                                                <div className="mt-6">
                                                    <div className="text-center">
                                                        <h5 className="text-md font-medium text-white mb-3">{areaPlotData.title}</h5>
                                                        {areaPlotData.plot && (
                                                            <img src={areaPlotData.plot} alt={areaPlotData.title} className="max-w-full h-auto mx-auto rounded-lg shadow-lg" />
                                                        )}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>



                                    {/* Distribution Plots */}
                                    {analysis.visualizations.distribution_plots && analysis.visualizations.distribution_plots.length > 0 && (
                                        <div className="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-6 border border-slate-700/50">
                                            <div className="flex items-center gap-2 mb-6">
                                                <svg className="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                                </svg>
                                                <h4 className="text-lg font-semibold text-white">Distribution Analysis</h4>
                                            </div>
                                            <div className="grid grid-cols-1 gap-6">
                                                {analysis.visualizations.distribution_plots.map((plot, index) => (
                                                    <div key={index} className="text-center">
                                                        <h5 className="text-md font-medium text-white mb-3">{plot.column} Distribution</h5>
                                                        <img src={plot.plot} alt={`Distribution of ${plot.column}`} className="max-w-full h-auto mx-auto rounded-lg shadow-lg" />
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}



                                    {/* AQI Pie Chart */}
                                    {analysis.visualizations.aqi_pie_chart && (
                                        <div className="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-6 border border-slate-700/50">
                                            <div className="flex items-center gap-2 mb-6">
                                                <svg className="w-5 h-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" />
                                                </svg>
                                                <h4 className="text-lg font-semibold text-white">AQI Category Distribution - Pie Chart</h4>
                                            </div>
                                            <div className="text-center">
                                                <img src={analysis.visualizations.aqi_pie_chart.plot} alt="AQI Pie Chart" className="max-w-full h-auto mx-auto rounded-lg shadow-lg" />
                                                <p className="text-sm text-slate-400 mt-3">{analysis.visualizations.aqi_pie_chart.description}</p>
                                            </div>
                                        </div>
                                    )}

                                    {/* AQI Waffle Chart */}
                                    {analysis.visualizations.aqi_waffle_chart && (
                                        <div className="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-6 border border-slate-700/50">
                                            <div className="flex items-center gap-2 mb-6">
                                                <svg className="w-5 h-5 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                                                </svg>
                                                <h4 className="text-lg font-semibold text-white">AQI Category Distribution - Waffle Chart</h4>
                                            </div>
                                            <div className="text-center">
                                                <img src={analysis.visualizations.aqi_waffle_chart.plot} alt="AQI Waffle Chart" className="max-w-full h-auto mx-auto rounded-lg shadow-lg" />
                                                <p className="text-sm text-slate-400 mt-3">{analysis.visualizations.aqi_waffle_chart.description}</p>
                                            </div>
                                        </div>
                                    )}

                                    {/* Time Series Plots */}
                                    {analysis.visualizations.time_series_plots && analysis.visualizations.time_series_plots.length > 0 && (
                                        <div className="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-6 border border-slate-700/50">
                                            <div className="flex items-center gap-2 mb-6">
                                                <svg className="w-5 h-5 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                                                </svg>
                                                <h4 className="text-lg font-semibold text-white">Time Series Analysis</h4>
                                            </div>
                                            <div className="grid grid-cols-1 gap-6">
                                                {analysis.visualizations.time_series_plots.map((plot, index) => (
                                                    <div key={index} className="text-center">
                                                        <h5 className="text-md font-medium text-white mb-3">{plot.title}</h5>
                                                        <img src={plot.plot} alt={plot.title} className="max-w-full h-auto mx-auto rounded-lg shadow-lg" />
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    {/* Pairwise Relationships */}
                                    {analysis.visualizations.pairwise_relationships && (
                                        <div className="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-6 border border-slate-700/50">
                                            <div className="flex items-center gap-2 mb-6">
                                                <svg className="w-5 h-5 text-pink-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" />
                                                </svg>
                                                <h4 className="text-lg font-semibold text-white">Pairwise Variable Relationships</h4>
                                            </div>
                                            <div className="text-center">
                                                <img src={analysis.visualizations.pairwise_relationships} alt="Pairwise Relationships" className="max-w-full h-auto mx-auto rounded-lg shadow-lg" />
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        // Forecast Tab Component - Dark Theme
        const ForecastTab = ({ tabState, updateTabState }) => {
            const { models, loading, selectedModel, prediction, uploadedDataset, datasetColumns, modelResults, trainedModel, trainedFeatures, trainedOutput } = tabState;
            const [inputFeatures, setInputFeatures] = useState([]);
            const [outputFeature, setOutputFeature] = useState('');
            const [selectedInputs, setSelectedInputs] = useState([]);
            const [selectedOutput, setSelectedOutput] = useState('');
            const [showInputDropdown, setShowInputDropdown] = useState(false);
            const [showOutputDropdown, setShowOutputDropdown] = useState(false);
            const [showModelDropdown, setShowModelDropdown] = useState(false);
            const [inputSearchTerm, setInputSearchTerm] = useState('');
            const [outputSearchTerm, setOutputSearchTerm] = useState('');
            const [modelSearchTerm, setModelSearchTerm] = useState('');
            
            const setSelectedModel = (model) => {
                updateTabState({ selectedModel: model });
            };
            
            const toggleModelSelection = (model) => {
                const currentSelection = selectedModel || [];
                const isSelected = currentSelection.includes(model);
                
                if (isSelected) {
                    // Remove model from selection
                    const newSelection = currentSelection.filter(m => m !== model);
                    updateTabState({ selectedModel: newSelection });
                } else {
                    // Add model to selection
                    const newSelection = [...currentSelection, model];
                    updateTabState({ selectedModel: newSelection });
                }
            };

            const handleDatasetUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                if (!file.name.endsWith('.csv')) {
                    alert('Please upload a CSV file only');
                    return;
                }
                
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    updateTabState({ loading: true });
                    const response = await fetch('/upload-dataset', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        updateTabState({ 
                            uploadedDataset: file.name,
                            datasetColumns: data.columns,
                            loading: false 
                        });
                        setSelectedInputs([]);
                        setSelectedOutput('');
                    } else {
                        alert(data.error);
                        updateTabState({ loading: false });
                    }
                } catch (error) {
                    console.error('Error uploading dataset:', error);
                    alert('Error uploading dataset');
                    updateTabState({ loading: false });
                }
            };

            const toggleInputFeature = (feature) => {
                if (selectedInputs.includes(feature)) {
                    setSelectedInputs(selectedInputs.filter(f => f !== feature));
                } else {
                    setSelectedInputs([...selectedInputs, feature]);
                }
                setInputSearchTerm('');
                setShowInputDropdown(false);
            };

            const removeInputFeature = (feature) => {
                setSelectedInputs(selectedInputs.filter(f => f !== feature));
            };

            const selectOutputFeature = (feature) => {
                setSelectedOutput(feature);
                setOutputSearchTerm('');
                setShowOutputDropdown(false);
            };

            const removeOutputFeature = () => {
                setSelectedOutput('');
            };

            const getAvailableFeatures = () => {
                if (!datasetColumns) return [];
                return datasetColumns.filter(col => 
                    !selectedInputs.includes(col) && 
                    col !== selectedOutput &&
                    col.toLowerCase().includes(inputSearchTerm.toLowerCase())
                );
            };

            const getAvailableOutputFeatures = () => {
                if (!datasetColumns) return [];
                return datasetColumns.filter(col => 
                    !selectedInputs.includes(col) &&
                    col.toLowerCase().includes(outputSearchTerm.toLowerCase())
                );
            };

            const getAvailableModels = () => {
                const models = ['Random Forest', 'KNN', 'Gradient Boost'];
                return models.filter(model => 
                    model.toLowerCase().includes(modelSearchTerm.toLowerCase())
                );
            };

            const handleInputKeyDown = (e) => {
                if (e.key === 'Backspace' && inputSearchTerm === '' && selectedInputs.length > 0) {
                    e.preventDefault();
                    removeInputFeature(selectedInputs[selectedInputs.length - 1]);
                }
            };

            const handleOutputKeyDown = (e) => {
                if (e.key === 'Backspace' && outputSearchTerm === '' && selectedOutput) {
                    e.preventDefault();
                    removeOutputFeature();
                }
            };

            // Close dropdowns when clicking outside
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (showInputDropdown || showOutputDropdown || showModelDropdown) {
                        const target = event.target;
                        const isInsideDropdown = target.closest('.dropdown-container');
                        if (!isInsideDropdown) {
                            setShowInputDropdown(false);
                            setShowOutputDropdown(false);
                            setShowModelDropdown(false);
                        }
                    }
                };

                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, [showInputDropdown, showOutputDropdown, showModelDropdown]);

            const handleTrainModel = async () => {
                if (!selectedModel || selectedModel.length === 0) {
                    alert('Please select at least one model type');
                    return;
                }
                
                if (!uploadedDataset || !selectedInputs || selectedInputs.length === 0) {
                    alert('Please upload a dataset and select input features first');
                    return;
                }
                
                if (!selectedOutput) {
                    alert('Please select an output feature');
                    return;
                }
                
                try {
                    updateTabState({ 
                        loading: true, 
                        modelResults: null  // Clear previous results
                    });
                    
                    // Train multiple models with progress tracking
                    const results = [];
                    const errors = [];
                    let completedCount = 0;
                    const totalModels = selectedModel.length;
                    
                    console.log(`Starting training for ${totalModels} models: ${selectedModel.join(', ')}`);
                    
                    for (const modelName of selectedModel) {
                        try {
                            console.log(`Training ${modelName}...`);
                            const response = await fetch('/train-model', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    model_name: modelName,
                                    input_features: selectedInputs,
                                    output_feature: selectedOutput,
                                    problem_type: tabState.problemType || 'regression',
                                    epochs: 100
                                })
                            });
                            
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            
                            const data = await response.json();
                            
                            if (data.success) {
                                results.push({
                                    model: modelName,
                                    ...data
                                });
                                console.log(`${modelName} trained successfully`);
                            } else {
                                errors.push(`${modelName}: ${data.error || 'Unknown error'}`);
                                console.error(`Error training ${modelName}:`, data.error);
                            }
                        } catch (error) {
                            errors.push(`${modelName}: ${error.message}`);
                            console.error(`Error training ${modelName}:`, error.message);
                        }
                        
                        completedCount++;
                        console.log(`Progress: ${completedCount}/${totalModels} models completed`);
                    }
                    
                    console.log(`Training completed. Successful: ${results.length}, Failed: ${errors.length}`);
                    
                    if (results.length > 0) {
                        const successfulModels = results.map(r => r.model);
                        let message = `${results.length} model${results.length > 1 ? 's' : ''} trained successfully: ${successfulModels.join(', ')}`;
                        
                        if (errors.length > 0) {
                            message += `\n\nFailed models: ${errors.join(', ')}`;
                        }
                        
                        alert(message);
                        
                        // Combine results for display
                        const combinedResults = {
                            success: true,
                            models: results,
                            metrics: {},
                            visualizations: []
                        };
                        
                        // Aggregate metrics for comparison
                        results.forEach(result => {
                            try {
                                const modelName = result.model_name || result.model || 'Unknown Model';
                                console.log(`Processing result for ${modelName}:`, result);
                                
                                if (result.metrics) {
                                    Object.keys(result.metrics).forEach(key => {
                                        if (!combinedResults.metrics[key]) {
                                            combinedResults.metrics[key] = {};
                                        }
                                        combinedResults.metrics[key][modelName] = result.metrics[key];
                                    });
                                }
                                if (result.visualizations && Array.isArray(result.visualizations)) {
                                    combinedResults.visualizations.push(...result.visualizations);
                                }
                            } catch (error) {
                                console.error(`Error processing result for ${result.model_name || result.model}:`, error);
                            }
                        });
                        
                        console.log('Final combined results:', combinedResults);
                        console.log('Metrics:', combinedResults.metrics);
                        console.log('Visualizations:', combinedResults.visualizations);
                        
                        updateTabState({ 
                            loading: false,
                            modelResults: combinedResults,
                            trainedModel: selectedModel,
                            trainedFeatures: selectedInputs,
                            trainedOutput: selectedOutput
                        });
                    } else {
                        const errorMessage = errors.length > 0 ? 
                            `All models failed to train:\n${errors.join('\n')}` : 
                            'All models failed to train';
                        alert(errorMessage);
                        updateTabState({ loading: false });
                    }
                } catch (error) {
                    console.error('Error training models:', error);
                    alert('Error training models');
                    updateTabState({ loading: false });
                }
            };



            // Model Upload Function
            const handleModelUpload = async (event) => {
                const files = Array.from(event.target.files);
                if (!files.length) return;
                
                try {
                    const formData = new FormData();
                    files.forEach((file, index) => {
                        formData.append(`models[]`, file);
                    });
                    
                    const response = await fetch('/api/upload-models', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        const uploadedModels = files.map(file => ({
                            name: file.name,
                            size: file.size,
                            path: data.paths ? data.paths[file.name] : null
                        }));
                        
                        updateTabState({ 
                            uploadedModels: [...(tabState.uploadedModels || []), ...uploadedModels]
                        });
                        
                        alert(`Successfully uploaded ${files.length} model(s)`);
                    } else {
                        throw new Error(data.error || 'Failed to upload models');
                    }
                } catch (error) {
                    console.error('Error uploading models:', error);
                    alert(`Error uploading models: ${error.message}`);
                }
            };

            // Model Inference Function
            const runModelInference = async () => {
                if (!tabState.selectedInferenceModel) {
                    alert('Please select a model for inference');
                    return;
                }
                
                try {
                    updateTabState({ isRunningInference: true, inferenceResults: null });
                    
                    const response = await fetch('/api/model-inference', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model_selection: tabState.selectedInferenceModel,
                            duration: tabState.predictionDuration || 1
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        updateTabState({ 
                            isRunningInference: false,
                            inferenceResults: {
                                model_name: data.model_name,
                                duration: data.duration,
                                predictions: data.predictions,
                                timestamp: new Date().toLocaleString()
                            }
                        });
                    } else {
                        throw new Error(data.error || 'Failed to run inference');
                    }
                } catch (error) {
                    console.error('Error running inference:', error);
                    alert(`Error running inference: ${error.message}`);
                    updateTabState({ isRunningInference: false });
                }
            };

            return (
                <div className="space-y-8">
                    <div className="text-center space-y-4">
                        <h2 className="text-3xl font-bold text-white">Weather Forecasting</h2>
                        <p className="text-lg text-slate-300 max-w-2xl mx-auto">
                            Use machine learning models to predict weather conditions and create accurate forecasts
                        </p>
                    </div>

                    <div className="max-w-4xl mx-auto space-y-8">
                        {/* Dataset Upload Card */}
                        <div className="relative z-20">
                            <div className="bg-slate-800/50 backdrop-blur-sm rounded-3xl p-6 border border-slate-700/50">
                                <div className="space-y-6">
                                    <div className="flex items-center gap-3 mb-4">
                                        <span className="text-2xl">üìä</span>
                                        <h3 className="text-xl font-semibold text-white">Dataset Upload</h3>
                                    </div>
                                    <p className="text-slate-300 mb-6">
                                        Upload your CSV dataset and select input/output features for machine learning
                                    </p>
                                    
                                    {!uploadedDataset ? (
                                        <div className="border-2 border-dashed border-slate-600 rounded-xl p-8 text-center">
                                            <input
                                                type="file"
                                                accept=".csv"
                                                onChange={handleDatasetUpload}
                                                className="hidden"
                                                id="dataset-upload"
                                            />
                                            <label htmlFor="dataset-upload" className="cursor-pointer">
                                                <div className="space-y-4">
                                                    <div className="text-6xl">üìÅ</div>
                                                    <div>
                                                        <p className="text-lg font-medium text-white">Upload CSV Dataset</p>
                                                        <p className="text-slate-400">Click to select a CSV file</p>
                                                    </div>
                                                </div>
                                            </label>
                                        </div>
                                    ) : (
                                        <div className="space-y-4">
                                            <div className="bg-slate-700/50 rounded-lg p-4">
                                                <div className="flex items-center justify-between">
                                                    <div className="flex items-center gap-3">
                                                        <span className="text-green-400">‚úì</span>
                                                        <span className="text-white font-medium">{uploadedDataset}</span>
                                                    </div>
                                                    <button
                                                        onClick={() => {
                                                            updateTabState({ uploadedDataset: null, datasetColumns: null });
                                                            setSelectedInputs([]);
                                                            setSelectedOutput('');
                                                        }}
                                                        className="text-slate-400 hover:text-red-400 transition-colors"
                                                    >
                                                        ‚úï
                                                    </button>
                                                </div>
                                            </div>

                                            {datasetColumns && (
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                    {/* Input Features Selection */}
                                                    <div className="space-y-3">
                                                        <label className="block text-sm font-medium text-slate-300">Input Features</label>
                                                        <div className="relative dropdown-container" style={{ zIndex: 100 }}>
                                                            <div
                                                                className="min-h-[48px] p-3 bg-slate-700 border border-slate-600 rounded-lg cursor-text flex flex-wrap gap-2 items-center"
                                                                onClick={() => setShowInputDropdown(true)}
                                                            >
                                                                {selectedInputs.map(feature => (
                                                                    <span
                                                                        key={feature}
                                                                        className="bg-blue-600 text-white px-2 py-1 rounded text-sm flex items-center gap-1 cursor-pointer min-w-fit"
                                                                        style={{ minWidth: 'fit-content' }}
                                                                        onClick={(e) => {
                                                                            e.stopPropagation();
                                                                            removeInputFeature(feature);
                                                                        }}
                                                                    >
                                                                        {feature}
                                                                    </span>
                                                                ))}
                                                                <input
                                                                    type="text"
                                                                    value={inputSearchTerm}
                                                                    onChange={(e) => {
                                                                        setInputSearchTerm(e.target.value);
                                                                        setShowInputDropdown(true);
                                                                    }}
                                                                    onKeyDown={handleInputKeyDown}
                                                                    onFocus={() => setShowInputDropdown(true)}
                                                                    placeholder={selectedInputs.length === 0 ? "Type to search input features..." : ""}
                                                                    className="bg-transparent border-none outline-none text-white placeholder-slate-400 flex-1 min-w-0"
                                                                />
                                                            </div>
                                                            
                                                            {showInputDropdown && (
                                                                <div className="absolute top-full left-0 right-0 bg-slate-700 border border-slate-600 rounded-lg shadow-lg max-h-48 overflow-y-auto mt-1">
                                                                    {getAvailableFeatures().map(feature => (
                                                                        <div
                                                                            key={feature}
                                                                            className="p-3 hover:bg-slate-600 cursor-pointer text-white"
                                                                            onClick={() => toggleInputFeature(feature)}
                                                                        >
                                                                            {feature}
                                                                        </div>
                                                                    ))}
                                                                    {getAvailableFeatures().length === 0 && (
                                                                        <div className="p-3 text-slate-400">No available features</div>
                                                                    )}
                                                                </div>
                                                            )}

                                                        </div>
                                                    </div>

                                                    {/* Output Feature Selection */}
                                                    <div className="space-y-3">
                                                        <label className="block text-sm font-medium text-slate-300">Output Feature</label>
                                                        <div className="relative dropdown-container" style={{ zIndex: 99 }}>
                                                            <div
                                                                className="min-h-[48px] p-3 bg-slate-700 border border-slate-600 rounded-lg cursor-text flex items-center gap-2"
                                                                onClick={() => setShowOutputDropdown(true)}
                                                            >
                                                                {selectedOutput ? (
                                                                    <span
                                                                        className="bg-green-600 text-white px-2 py-1 rounded text-sm flex items-center gap-1 cursor-pointer min-w-fit"
                                                                        style={{ minWidth: 'fit-content' }}
                                                                        onClick={(e) => {
                                                                            e.stopPropagation();
                                                                            removeOutputFeature();
                                                                        }}
                                                                    >
                                                                        {selectedOutput}
                                                                    </span>
                                                                ) : null}
                                                                <input
                                                                    type="text"
                                                                    value={outputSearchTerm}
                                                                    onChange={(e) => {
                                                                        setOutputSearchTerm(e.target.value);
                                                                        setShowOutputDropdown(true);
                                                                    }}
                                                                    onKeyDown={handleOutputKeyDown}
                                                                    onFocus={() => setShowOutputDropdown(true)}
                                                                    placeholder={selectedOutput ? "" : "Type to search output feature..."}
                                                                    className="bg-transparent border-none outline-none text-white placeholder-slate-400 flex-1 min-w-0"
                                                                />
                                                            </div>
                                                            
                                                            {showOutputDropdown && (
                                                                <div className="absolute top-full left-0 right-0 bg-slate-700 border border-slate-600 rounded-lg shadow-lg max-h-48 overflow-y-auto mt-1">
                                                                    {getAvailableOutputFeatures().map(feature => (
                                                                        <div
                                                                            key={feature}
                                                                            className="p-3 hover:bg-slate-600 cursor-pointer text-white"
                                                                            onClick={() => selectOutputFeature(feature)}
                                                                        >
                                                                            {feature}
                                                                        </div>
                                                                    ))}
                                                                    {getAvailableOutputFeatures().length === 0 && (
                                                                        <div className="p-3 text-slate-400">No available features</div>
                                                                    )}
                                                                </div>
                                                            )}

                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* Train Model Card */}
                        <div className="relative z-10">
                            <div className="bg-slate-800/50 backdrop-blur-sm rounded-3xl p-6 border border-slate-700/50">
                                <div className="space-y-6">
                                    <div className="flex items-center gap-3 mb-4">
                                        <BrainIcon />
                                        <h3 className="text-xl font-semibold text-white">Train Model</h3>
                                    </div>
                                    <p className="text-slate-300 mb-6">
                                        Configure and train a machine learning model for weather prediction
                                    </p>
                                    
                                    <div className="space-y-3">
                                        {/* Problem Type Selection */}
                                        <div className="space-y-3">
                                            <label className="block text-sm font-medium text-slate-300">Problem Type</label>
                                            <div className="flex gap-3">
                                                <button
                                                    onClick={() => updateTabState({ problemType: 'regression' })}
                                                    className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                                                        (tabState.problemType || 'regression') === 'regression' 
                                                            ? 'bg-blue-600 text-white' 
                                                            : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                                                    }`}
                                                >
                                                    Regression
                                                </button>
                                                <button
                                                    onClick={() => updateTabState({ problemType: 'classification' })}
                                                    className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                                                        tabState.problemType === 'classification' 
                                                            ? 'bg-blue-600 text-white' 
                                                            : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                                                    }`}
                                                >
                                                    Classification
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <label className="block text-sm font-medium text-slate-300">Model Type</label>
                                        <div className="relative dropdown-container">
                                            <div
                                                className="min-h-[48px] p-3 bg-slate-700 border border-slate-600 rounded-lg cursor-text flex items-center gap-2 flex-wrap"
                                                onClick={() => setShowModelDropdown(true)}
                                            >
                                                {selectedModel && selectedModel.length > 0 ? (
                                                    selectedModel.map(model => (
                                                        <span
                                                            key={model}
                                                            className="bg-blue-600 text-white px-2 py-1 rounded text-sm flex items-center gap-1 cursor-pointer min-w-fit"
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                toggleModelSelection(model);
                                                            }}
                                                        >
                                                            {model}
                                                            <span className="text-xs">√ó</span>
                                                        </span>
                                                    ))
                                                ) : null}
                                                <input
                                                    type="text"
                                                    value={modelSearchTerm}
                                                    onChange={(e) => {
                                                        setModelSearchTerm(e.target.value);
                                                        setShowModelDropdown(true);
                                                    }}
                                                    onFocus={() => setShowModelDropdown(true)}
                                                    placeholder={selectedModel && selectedModel.length > 0 ? "" : "Type to search and select multiple models..."}
                                                    className="bg-transparent border-none outline-none text-white placeholder-slate-400 flex-1 min-w-0"
                                                />
                                            </div>
                                            
                                            {showModelDropdown && (
                                                <div className="absolute top-full left-0 right-0 bg-slate-700 border border-slate-600 rounded-lg shadow-lg max-h-48 overflow-y-auto mt-1" style={{ zIndex: 999 }}>
                                                    {getAvailableModels().map(model => {
                                                        const isSelected = selectedModel && selectedModel.includes(model);
                                                        return (
                                                            <div
                                                                key={model}
                                                                className="p-3 hover:bg-slate-600 cursor-pointer text-white flex items-center gap-3"
                                                                onClick={() => {
                                                                    toggleModelSelection(model);
                                                                    setModelSearchTerm('');
                                                                }}
                                                            >
                                                                <input
                                                                    type="checkbox"
                                                                    checked={isSelected}
                                                                    onChange={() => {}}
                                                                    className="w-4 h-4 text-blue-600 bg-slate-600 border-slate-500 rounded focus:ring-blue-500"
                                                                />
                                                                <span>{model}</span>
                                                            </div>
                                                        );
                                                    })}
                                                    {getAvailableModels().length === 0 && (
                                                        <div className="p-3 text-slate-400">No available models</div>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                    
                                    <Button 
                                        onClick={handleTrainModel} 
                                        disabled={loading} 
                                        className="w-full bg-purple-600 hover:bg-purple-700 text-white"
                                    >
                                        {loading ? 
                                            `Training ${selectedModel?.length || 0} model${(selectedModel?.length || 0) > 1 ? 's' : ''}...` : 
                                            'Train Model'
                                        }
                                    </Button>
                                </div>
                            </div>
                        </div>

                        {/* Model Performance Card */}
                        <div className="relative">
                            <div className="bg-slate-800/50 backdrop-blur-sm rounded-3xl p-6 border border-slate-700/50">
                                <div className="space-y-4">
                                    <h3 className="text-xl font-semibold text-white">Model Performance</h3>
                                    <p className="text-slate-300 mb-6">
                                        View metrics and performance of your trained models
                                    </p>
                                    
                                    {!loading && modelResults ? (
                                        (() => {
                                            try {
                                                return (
                                                    <div className="space-y-6">
                                            {/* Metrics Table */}
                                            <div className="bg-slate-700/50 rounded-lg p-4">
                                                <h4 className="text-lg font-medium text-white mb-4">Performance Metrics Comparison</h4>
                                                
                                                {/* Problem Type Display */}
                                                {modelResults.metrics && modelResults.metrics['Problem Type'] && (
                                                    <div className="mb-4">
                                                        <p className="text-slate-300">
                                                            <strong>Problem Type:</strong> {(() => {
                                                                const problemType = modelResults.metrics['Problem Type'];
                                                                if (typeof problemType === 'string') {
                                                                    return problemType;
                                                                } else if (typeof problemType === 'object' && problemType !== null) {
                                                                    const values = Object.values(problemType);
                                                                    return values.length > 0 ? values[0] : 'Unknown';
                                                                }
                                                                return 'Unknown';
                                                            })()}
                                                        </p>
                                                    </div>
                                                )}
                                                
                                                {modelResults.metrics && Object.keys(modelResults.metrics).length > 0 ? (
                                                    <div className="overflow-x-auto">
                                                        <table className="w-full text-white">
                                                            <thead>
                                                                <tr className="border-b border-slate-600">
                                                                    <th className="text-left p-2 text-slate-300">Metric</th>
                                                                    {(() => {
                                                                        try {
                                                                            const metricsValues = Object.values(modelResults.metrics);
                                                                            if (metricsValues.length > 0 && metricsValues[0] && typeof metricsValues[0] === 'object') {
                                                                                return Object.keys(metricsValues[0]).map(model => (
                                                                                    <th key={model} className="text-left p-2 text-slate-300">{model}</th>
                                                                                ));
                                                                            } else {
                                                                                return <th className="text-left p-2 text-slate-300">Value</th>;
                                                                            }
                                                                        } catch (error) {
                                                                            console.error('Error rendering table headers:', error);
                                                                            return <th className="text-left p-2 text-slate-300">Value</th>;
                                                                        }
                                                                    })()}
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                {Object.entries(modelResults.metrics)
                                                                    .filter(([key]) => key.startsWith('Test ') && key !== 'Test Samples') // Only show test metrics, exclude sample count
                                                                    .map(([key, value]) => {
                                                                        try {
                                                                            return (
                                                                                <tr key={key} className="border-b border-slate-700">
                                                                                    <td className="p-2 font-medium text-slate-300">{key}</td>
                                                                                    {typeof value === 'object' && value !== null ? 
                                                                                        Object.entries(value).map(([model, score]) => (
                                                                                            <td key={model} className="p-2 text-white font-semibold">
                                                                                                {typeof score === 'number' ? score.toFixed(4) : (score || 'N/A')}
                                                                                            </td>
                                                                                        )) : 
                                                                                        <td className="p-2 text-white font-semibold">
                                                                                            {typeof value === 'number' ? value.toFixed(4) : (value || 'N/A')}
                                                                                        </td>
                                                                                    }
                                                                                </tr>
                                                                            );
                                                                        } catch (error) {
                                                                            console.error(`Error rendering metric ${key}:`, error);
                                                                            return (
                                                                                <tr key={key} className="border-b border-slate-700">
                                                                                    <td className="p-2 font-medium text-slate-300">{key}</td>
                                                                                    <td className="p-2 text-white font-semibold">Error</td>
                                                                                </tr>
                                                                            );
                                                                        }
                                                                    })}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                ) : (
                                                    <p className="text-slate-300">No metrics available</p>
                                                )}
                                            </div>
                                            
                                            {/* Visualizations */}
                                            {modelResults.visualizations && modelResults.visualizations.length > 0 && (
                                                <div className="space-y-4">
                                                    <h4 className="text-lg font-medium text-white">Performance Visualizations</h4>
                                                    {modelResults.visualizations.map((viz, index) => {
                                                        console.log(`Rendering visualization ${index}:`, viz);
                                                        try {
                                                            return (
                                                                <div key={index} className="bg-slate-700/30 rounded-lg p-4">
                                                                    <h5 className="text-md font-medium text-white mb-3">{viz.title || `Visualization ${index + 1}`}</h5>
                                                                    {viz.image ? (
                                                                        <div className="w-full flex justify-center">
                                                                            <img 
                                                                                src={viz.image} 
                                                                                alt={viz.title || `Visualization ${index + 1}`} 
                                                                                className="max-w-full h-auto mx-auto rounded-lg shadow-lg" 
                                                                            />
                                                                        </div>
                                                                    ) : (
                                                                        <div className="text-slate-300">
                                                                            <p>No visualization data available</p>
                                                                            <p className="text-xs">Debug: image={viz.image ? 'present' : 'missing'}</p>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            );
                                                        } catch (error) {
                                                            console.error(`Error rendering visualization ${index}:`, error);
                                                            return (
                                                                <div key={index} className="bg-slate-700/30 rounded-lg p-4">
                                                                    <p className="text-red-400">Error rendering visualization: {error.message}</p>
                                                                </div>
                                                            );
                                                        }
                                                    })}
                                                </div>
                                            )}
                                            
                                            {/* Model Summary */}
                                            <div className="bg-slate-700/50 rounded-lg p-4">
                                                <h4 className="text-lg font-medium text-white mb-2">Model Summary</h4>
                                                <div className="text-slate-300">
                                                    <p><strong>Models:</strong> {Array.isArray(trainedModel) ? trainedModel.join(', ') : (trainedModel || 'Unknown')}</p>
                                                    <p><strong>Input Features:</strong> {trainedFeatures?.join(', ') || 'None selected'}</p>
                                                    <p><strong>Output Feature:</strong> {trainedOutput || 'Unknown'}</p>
                                                    <p><strong>Problem Type:</strong> {(() => {
                                                        const problemType = modelResults.metrics?.['Problem Type'];
                                                        if (typeof problemType === 'string') {
                                                            return problemType;
                                                        } else if (typeof problemType === 'object' && problemType !== null) {
                                                            // If it's an object, get the first value or convert to string
                                                            const values = Object.values(problemType);
                                                            return values.length > 0 ? values[0] : 'Unknown';
                                                        } else {
                                                            return 'Unknown';
                                                        }
                                                    })()}</p>
                                                    {modelResults.models && (
                                                        <p><strong>Trained Models:</strong> {modelResults.models.length} model{modelResults.models.length > 1 ? 's' : ''}</p>
                                                    )}
                                                </div>
                                            </div>
                                                    </div>
                                                );
                                            } catch (error) {
                                                console.error('Error rendering model results:', error);
                                                return (
                                                    <div className="bg-red-900/20 border border-red-500/50 rounded-lg p-4">
                                                        <p className="text-red-400">Error displaying model results. Please try training again.</p>
                                                    </div>
                                                );
                                            }
                                        })()
                                    ) : loading ? (
                                        <div className="text-center py-8">
                                            <div className="text-4xl mb-4">‚è≥</div>
                                            <p className="text-slate-400">Training models in progress...</p>
                                            <p className="text-slate-500 text-sm mt-2">Please wait for all models to complete training</p>
                                        </div>
                                    ) : (
                                        <div className="text-center py-8">
                                            <div className="text-4xl mb-4">üìä</div>
                                            <p className="text-slate-400">Train a model to see performance metrics</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>



                        {/* Model Inference Card */}
                        <div className="relative">
                            <div className="bg-slate-800/50 backdrop-blur-sm rounded-3xl p-6 border border-slate-700/50">
                                <div className="space-y-4">
                                    <div className="flex items-center gap-3 mb-4">
                                        <span className="text-2xl">üöÄ</span>
                                        <h3 className="text-xl font-semibold text-white">Model Inference</h3>
                                    </div>
                                    <p className="text-slate-300 mb-6">
                                        Load trained models and run predictions for specified durations
                                    </p>
                                    
                                    <div className="space-y-6">
                                        {/* Upload Custom Models Section */}
                                        <div className="bg-slate-700/30 rounded-lg p-4">
                                            <div className="flex items-center gap-2 mb-3">
                                                <span className="text-blue-400">üìÅ</span>
                                                <h4 className="text-lg font-medium text-white">Upload Custom Models</h4>
                                            </div>
                                            <p className="text-slate-300 text-sm mb-4">
                                                Upload your own trained models (.joblib files) for inference
                                            </p>
                                            <div className="space-y-3">
                                                <input
                                                    type="file"
                                                    multiple
                                                    accept=".joblib,.pkl"
                                                    onChange={(e) => handleModelUpload(e)}
                                                    className="block w-full text-sm text-slate-300
                                                        file:mr-4 file:py-2 file:px-4
                                                        file:rounded-lg file:border-0
                                                        file:text-sm file:font-medium
                                                        file:bg-blue-600 file:text-white
                                                        hover:file:bg-blue-700
                                                        file:cursor-pointer"
                                                />
                                                {tabState.uploadedModels && tabState.uploadedModels.length > 0 && (
                                                    <div className="mt-2">
                                                        <p className="text-sm text-green-400 mb-2">
                                                            ‚úì {tabState.uploadedModels.length} model(s) uploaded successfully
                                                        </p>
                                                        <div className="space-y-1 max-h-20 overflow-y-auto">
                                                            {tabState.uploadedModels.map((model, index) => (
                                                                <div key={index} className="text-xs text-slate-400 flex justify-between">
                                                                    <span>{model.name}</span>
                                                                    <span>{(model.size / 1024).toFixed(1)} KB</span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>

                                        {/* Available Models Section */}
                                        <div className="bg-slate-700/30 rounded-lg p-4">
                                            <div className="flex items-center gap-2 mb-3">
                                                <span className="text-green-400">‚ö°</span>
                                                <h4 className="text-lg font-medium text-white">Available Models</h4>
                                            </div>
                                            <p className="text-slate-300 text-sm mb-4">
                                                Select a model for inference from trained or uploaded models
                                            </p>
                                            
                                            <div className="space-y-4">
                                                {/* Model Selection Dropdown */}
                                                <div className="space-y-2">
                                                    <label className="block text-sm font-medium text-slate-300">Select Model</label>
                                                    <select 
                                                        className="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-white"
                                                        onChange={(e) => updateTabState({ selectedInferenceModel: e.target.value })}
                                                        value={tabState.selectedInferenceModel || ''}
                                                    >
                                                        <option value="">Choose a model for inference...</option>
                                                        
                                                        {/* Previously Trained Models */}
                                                        {modelResults && modelResults.models && modelResults.models.length > 0 && (
                                                            <optgroup label="üéØ Previously Trained Models">
                                                                {modelResults.models.map((result, index) => (
                                                                    <option key={`trained-${index}`} value={`trained:${result.model_name || result.model}`}>
                                                                        {result.model_name || result.model} (Trained)
                                                                    </option>
                                                                ))}
                                                            </optgroup>
                                                        )}
                                                        
                                                        {/* Uploaded Models */}
                                                        {tabState.uploadedModels && tabState.uploadedModels.length > 0 && (
                                                            <optgroup label="üìÅ Uploaded Models">
                                                                {tabState.uploadedModels.map((model, index) => (
                                                                    <option key={`uploaded-${index}`} value={`uploaded:${model.name}`}>
                                                                        {model.name} (Uploaded)
                                                                    </option>
                                                                ))}
                                                            </optgroup>
                                                        )}
                                                    </select>
                                                </div>

                                                {/* Prediction Duration Input */}
                                                <div className="space-y-2">
                                                    <label className="block text-sm font-medium text-slate-300">Prediction Duration (Days)</label>
                                                    <input
                                                        type="number"
                                                        min="1"
                                                        step="1"
                                                        placeholder="Enter prediction duration (minimum 1 day)"
                                                        className="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400"
                                                        value={tabState.predictionDuration || 1}
                                                        onChange={(e) => updateTabState({ predictionDuration: Math.max(1, parseInt(e.target.value) || 1) })}
                                                    />
                                                    <p className="text-xs text-slate-400">
                                                        Specify how many days into the future to predict (default: 1 day)
                                                    </p>
                                                </div>

                                                {/* Run Inference Button */}
                                                <div className="pt-2">
                                                    <button
                                                        onClick={() => runModelInference()}
                                                        disabled={!tabState.selectedInferenceModel || tabState.isRunningInference}
                                                        className="w-full bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 disabled:cursor-not-allowed px-4 py-3 rounded-lg text-white font-medium transition-colors"
                                                    >
                                                        {tabState.isRunningInference ? 'Running Inference...' : 'Run Prediction'}
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Inference Results */}
                                        {tabState.inferenceResults && (
                                            <div className="bg-slate-700/30 rounded-lg p-4">
                                                <div className="flex items-center gap-2 mb-3">
                                                    <span className="text-yellow-400">üìä</span>
                                                    <h4 className="text-lg font-medium text-white">Prediction Results</h4>
                                                </div>
                                                <div className="space-y-3">
                                                    <div className="bg-slate-800/50 rounded-lg p-4">
                                                        <div className="grid grid-cols-2 gap-4 text-sm">
                                                            <div>
                                                                <span className="text-slate-400">Model:</span>
                                                                <span className="text-white ml-2">{tabState.inferenceResults.model_name}</span>
                                                            </div>
                                                            <div>
                                                                <span className="text-slate-400">Duration:</span>
                                                                <span className="text-white ml-2">{tabState.inferenceResults.duration} days</span>
                                                            </div>
                                                            <div>
                                                                <span className="text-slate-400">Predictions:</span>
                                                                <span className="text-white ml-2">{tabState.inferenceResults.predictions?.length || 0}</span>
                                                            </div>
                                                            <div>
                                                                <span className="text-slate-400">Timestamp:</span>
                                                                <span className="text-white ml-2">{tabState.inferenceResults.timestamp}</span>
                                                            </div>
                                                        </div>
                                                        
                                                        {tabState.inferenceResults.predictions && (
                                                            <div className="mt-4">
                                                                <h5 className="text-white font-medium mb-2">Prediction Values:</h5>
                                                                <div className="bg-slate-900/50 rounded p-3 max-h-32 overflow-y-auto">
                                                                    <div className="space-y-1 text-sm">
                                                                        {tabState.inferenceResults.predictions.map((pred, index) => (
                                                                            <div key={index} className="flex justify-between">
                                                                                <span className="text-slate-300">Day {index + 1}:</span>
                                                                                <span className="text-green-400 font-mono">
                                                                                    {typeof pred === 'number' ? pred.toFixed(4) : pred}
                                                                                </span>
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Settings Tab Component - Dark Theme
        const SettingsTab = ({ tabState, updateTabState }) => {
            const { apiSettings, loading } = tabState;
            const [settings, setSettings] = useState(apiSettings || {
                accuweather_api_key: ''
            });
            const [showKeys, setShowKeys] = useState({});

            const handleSettingChange = (key, value) => {
                const newSettings = { ...settings, [key]: value };
                setSettings(newSettings);
                updateTabState({ apiSettings: newSettings });
            };

            const toggleShowKey = (key) => {
                setShowKeys(prev => ({ ...prev, [key]: !prev[key] }));
            };

            const handleSave = async () => {
                try {
                    updateTabState({ loading: true });
                    const response = await fetch('/update-api-settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(settings)
                    });
                    const data = await response.json();
                    if (data.success) {
                        alert('Settings saved successfully!');
                    } else {
                        alert(data.error);
                    }
                    updateTabState({ loading: false });
                } catch (error) {
                    console.error('Error saving settings:', error);
                    alert('Error saving settings');
                    updateTabState({ loading: false });
                }
            };

            const EyeIcon = ({ show }) => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    {show ? (
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    ) : (
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21" />
                    )}
                </svg>
            );

            return (
                <div className="space-y-8">
                    <div className="text-center space-y-4">
                        <h2 className="text-3xl font-bold text-white">API Settings</h2>
                        <p className="text-lg text-slate-300 max-w-2xl mx-auto">
                            Configure your API credentials for AccuWeather and Watsonx services
                        </p>
                    </div>

                    <div className="max-w-2xl mx-auto space-y-6">
                        <div className="bg-slate-800/50 backdrop-blur-sm rounded-3xl p-6 border border-slate-700/50">
                            <div className="space-y-6">
                                <div className="flex items-center gap-3 mb-4">
                                    <span className="text-2xl">üå§Ô∏è</span>
                                    <h3 className="text-xl font-semibold text-white">AccuWeather API</h3>
                                </div>
                                <p className="text-slate-300 mb-6">
                                    Required for real-time weather data and forecasts
                                </p>
                                
                                <div>
                                    <label className="block text-sm font-medium text-slate-300 mb-2">API Key</label>
                                    <div className="relative">
                                        <input
                                            type={showKeys.accuweather ? "text" : "password"}
                                            className="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 pr-10"
                                            placeholder="Enter your AccuWeather API key"
                                            value={settings.accuweather_api_key}
                                            onChange={(e) => handleSettingChange('accuweather_api_key', e.target.value)}
                                        />
                                        <button
                                            type="button"
                                            className="absolute right-3 top-3 text-slate-400 hover:text-white"
                                            onClick={() => toggleShowKey('accuweather')}
                                        >
                                            <EyeIcon show={showKeys.accuweather} />
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>



                        <div className="flex justify-center">
                            <Button 
                                onClick={handleSave} 
                                disabled={loading} 
                                className="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 text-lg"
                            >
                                {loading ? 'Saving...' : 'Save Settings'}
                            </Button>
                        </div>
                    </div>
                </div>
            );
        };

        // Navigation Component
        const Navigation = ({ activeTab, onTabChange }) => (
            <div className="w-full border-b bg-white/80 backdrop-blur-sm sticky top-0 z-50">
                <div className="container mx-auto px-4 py-4">
                    <div className="flex items-center justify-between mb-4">
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                                <span className="text-white text-lg">üå§Ô∏è</span>
                            </div>
                            <h1 className="text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                                Weather Dashboard
                            </h1>
                        </div>
                    </div>
                    
                    <div className="flex gap-1 p-1 bg-gray-100 rounded-lg w-fit">
                        {[
                            { id: 'home', label: 'Home', icon: HomeIcon },
                            { id: 'data', label: 'Weather Data', icon: ChartIcon },
                            { id: 'forecast', label: 'Forecast', icon: BrainIcon },
                            { id: 'settings', label: 'API Settings', icon: SettingsIcon }
                        ].map(({ id, label, icon: Icon }) => (
                            <button
                                key={id}
                                onClick={() => onTabChange(id)}
                                className={cn(
                                    "flex items-center gap-2 px-4 py-2 rounded-md text-sm font-medium transition-all",
                                    activeTab === id 
                                        ? "bg-white text-gray-900 shadow-sm" 
                                        : "text-gray-600 hover:text-gray-900"
                                )}
                            >
                                <Icon />
                                <span className="hidden sm:inline">{label}</span>
                            </button>
                        ))}
                    </div>
                </div>
            </div>
        );

        // Main App Component
        const App = () => {
            const [activeTab, setActiveTab] = useState('home');
            
            // Persistent tab state
            const [tabStates, setTabStates] = useState({
                home: {
                    weather: null,
                    loading: false,
                    error: null,
                    searchLocation: 'Ho Chi Minh City'
                },
                data: {
                    analysis: null,
                    loading: false,
                    showNotebook: false,
                    selectedOption: null,
                    selectedFile: null,
                    searchLocation: '',
                    searchDays: 30,
                    isDragOver: false,
                    showColumnRemover: false,
                    selectedColumns: [],
                    columnSearchTerm: '',
                    showColumnDropdown: false,
                    outlierHandlingDecision: null,
                    columnRemovalDecision: null,
                    columnRemovalCompleted: false,
                    negativeValueHandlingDecision: null,
                    negativeValueInfo: null,
                    selectedAreaFeatures: ['pm2_5', 'pm10'],
                    showAreaFeatureDropdown: false,
                    areaPlotData: null,
                    loadingAreaPlot: false
                },
                forecast: {
                    models: [],
                    loading: false,
                    selectedModel: [],
                    prediction: null,
                    uploadedDataset: null,
                    datasetColumns: null
                },
                settings: {
                    apiSettings: null,
                    loading: false
                }
            });
            
            // Update tab state helper
            const updateTabState = (tab, newState) => {
                setTabStates(prev => ({
                    ...prev,
                    [tab]: { ...prev[tab], ...newState }
                }));
            };
            

            
            // Chatbot state
            const [chatbotOpen, setChatbotOpen] = useState(false);
            const [chatMessages, setChatMessages] = useState({
                watson: [],
                gemini: []
            });
            const [chatInput, setChatInput] = useState('');
            const [chatLoading, setChatLoading] = useState(false);
            const [chatbotConfig, setChatbotConfig] = useState(null);
            const [selectedChatbot, setSelectedChatbot] = useState('watson');

            // Load chatbot configuration on mount
            useEffect(() => {
                fetch('/chatbot-config')
                    .then(res => res.json())
                    .then(config => {
                        setChatbotConfig(config);
                        setSelectedChatbot(config.default_chatbot || 'watson');
                    })
                    .catch(err => console.error('Failed to load chatbot config:', err));
            }, []);

            // Handle chatbot switching - preserves chat history
            const handleChatbotSwitch = (newChatbot) => {
                if (newChatbot !== selectedChatbot) {
                    setSelectedChatbot(newChatbot);
                    // Chat history is preserved per chatbot
                }
            };

            // Send message to selected chatbot
            const sendChatMessage = async () => {
                if (!chatInput.trim() || chatLoading) return;
                
                const userMessage = chatInput.trim();
                setChatInput('');
                setChatLoading(true);
                
                // Add user message to current chatbot's chat
                setChatMessages(prev => ({
                    ...prev,
                    [selectedChatbot]: [...prev[selectedChatbot], { text: userMessage, sender: 'user' }]
                }));
                
                try {
                    const response = await fetch('/api/message', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            text: userMessage,
                            chatbot_type: selectedChatbot,
                            conversation_history: chatMessages[selectedChatbot]
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        // Add assistant response to current chatbot's chat
                        if (data && data.length > 0) {
                            const assistantText = data.map(item => item.text || '').join(' ');
                            setChatMessages(prev => ({
                                ...prev,
                                [selectedChatbot]: [...prev[selectedChatbot], { text: assistantText, sender: 'assistant' }]
                            }));
                        } else {
                            setChatMessages(prev => ({
                                ...prev,
                                [selectedChatbot]: [...prev[selectedChatbot], { text: 'No response received', sender: 'assistant' }]
                            }));
                        }
                    } else {
                        setChatMessages(prev => ({
                            ...prev,
                            [selectedChatbot]: [...prev[selectedChatbot], { text: data.error || 'Error occurred', sender: 'error' }]
                        }));
                    }
                } catch (error) {
                    setChatMessages(prev => ({
                        ...prev,
                        [selectedChatbot]: [...prev[selectedChatbot], { text: 'Connection error', sender: 'error' }]
                    }));
                } finally {
                    setChatLoading(false);
                }
            };

            // Handle enter key press
            const handleChatKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendChatMessage();
                }
            };



            const renderTabContent = () => {
                switch (activeTab) {
                    case 'home':
                        return <HomeTab 
                            onTabChange={setActiveTab} 
                            tabState={tabStates.home}
                            updateTabState={(newState) => updateTabState('home', newState)}
                        />;
                    case 'data':
                        return <DataTab 
                            tabState={tabStates.data}
                            updateTabState={(newState) => updateTabState('data', newState)}
                        />;
                    case 'forecast':
                        return <ForecastTab 
                            tabState={tabStates.forecast}
                            updateTabState={(newState) => updateTabState('forecast', newState)}
                        />;
                    case 'settings':
                        return <SettingsTab 
                            tabState={tabStates.settings}
                            updateTabState={(newState) => updateTabState('settings', newState)}
                        />;
                    default:
                        return <HomeTab 
                            onTabChange={setActiveTab} 
                            tabState={tabStates.home}
                            updateTabState={(newState) => updateTabState('home', newState)}
                        />;
                }
            };

            const CloudIcon = () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.002 4.002 0 003 15z" />
                </svg>
            );

            return (
                <div className="min-h-screen text-white relative">
                    {/* --- CHANGE IS HERE --- */}
                    {/* I've replaced the local image with a URL from the web for debugging. */}
                    {/* I also corrected the typo "moutain" to "mountain" for good practice. */}
                    <div 
                        className="fixed inset-0 bg-cover bg-center bg-no-repeat" 
                        style={{
                            backgroundImage: 'url("https://images.unsplash.com/photo-1726107506560-1f382151ab0a?w=2400&h=1601&q=80&auto=format&fit=crop")',
                            zIndex: -10
                        }}
                    ></div>
                    {/* I made the overlay slightly more transparent (50% instead of 60%) */}
                    <div className="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" style={{zIndex: -5}}></div>
                    <div className="relative z-10">
                    {activeTab === 'home' ? (
                        <div className="relative">
                            {/* Tab Navigation positioned above content */}
                            <div className="flex justify-center pt-6 pb-4">
                                <div className="flex gap-1 p-1 bg-slate-800/80 backdrop-blur-sm rounded-lg border border-slate-700/50">
                                    {[
                                        { id: 'home', label: 'Home', icon: HomeIcon },
                                        { id: 'data', label: 'Data', icon: ChartIcon },
                                        { id: 'forecast', label: 'Forecast', icon: CloudIcon },
                                        { id: 'settings', label: 'Settings', icon: SettingsIcon }
                                    ].map(({ id, label, icon: Icon }) => (
                                        <button
                                            key={id}
                                            onClick={() => setActiveTab(id)}
                                            className={cn(
                                                "flex items-center gap-2 px-4 py-2 rounded-md text-sm font-medium transition-all",
                                                activeTab === id 
                                                    ? "bg-white/20 text-white shadow-sm" 
                                                    : "text-slate-300 hover:text-white hover:bg-white/10"
                                            )}
                                        >
                                            <Icon />
                                            <span className="hidden sm:inline">{label}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                            {renderTabContent()}
                        </div>
                    ) : (
                        <div className="relative">
                            {/* Dark Theme Navigation for other tabs */}
                            <div className="flex justify-center pt-6 pb-4">
                                <div className="flex gap-1 p-1 bg-slate-800/80 backdrop-blur-sm rounded-lg border border-slate-700/50">
                                    {[
                                        { id: 'home', label: 'Home', icon: HomeIcon },
                                        { id: 'data', label: 'Data', icon: ChartIcon },
                                        { id: 'forecast', label: 'Forecast', icon: CloudIcon },
                                        { id: 'settings', label: 'Settings', icon: SettingsIcon }
                                    ].map(({ id, label, icon: Icon }) => (
                                        <button
                                            key={id}
                                            onClick={() => setActiveTab(id)}
                                            className={cn(
                                                "flex items-center gap-2 px-4 py-2 rounded-md text-sm font-medium transition-all",
                                                activeTab === id 
                                                    ? "bg-white/20 text-white shadow-sm" 
                                                    : "text-slate-300 hover:text-white hover:bg-white/10"
                                            )}
                                        >
                                            <Icon />
                                            <span className="hidden sm:inline">{label}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div className="container mx-auto px-4 py-8">
                                {renderTabContent()}
                            </div>
                        </div>
                    )}

                    {/* Floating Chat Button */}
                    <button
                        onClick={() => setChatbotOpen(true)}
                        className="fixed bottom-6 right-6 w-14 h-14 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center z-50"
                        aria-label="Open Watson Assistant Chat"
                    >
                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                        </svg>
                    </button>

                    {/* Chatbot Modal */}
                    {chatbotOpen && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md h-[32rem] flex flex-col">
                                {/* Header */}
                                <div className="flex items-center justify-between p-4 border-b bg-blue-600 text-white rounded-t-2xl">
                                    <div className="flex items-center gap-3">
                                        <div className="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center">
                                            ü§ñ
                                        </div>
                                        <div>
                                            <h3 className="font-semibold">
                                                {selectedChatbot === 'watson' ? 'Watson Assistant' : 'Gemini'}
                                            </h3>
                                            <p className="text-xs text-blue-100">Weather AI Helper</p>
                                        </div>
                                    </div>
                                    <button
                                        onClick={() => setChatbotOpen(false)}
                                        className="w-8 h-8 rounded-full hover:bg-white/20 flex items-center justify-center transition-colors"
                                    >
                                        ‚úï
                                    </button>
                                </div>

                                {/* Chatbot Selector */}
                                {chatbotConfig?.chatbots && (
                                    <div className="p-3 border-b bg-gray-50">
                                        <div className="flex gap-2">
                                            {Object.entries(chatbotConfig.chatbots).map(([key, bot]) => (
                                                <button
                                                    key={key}
                                                    onClick={() => handleChatbotSwitch(key)}
                                                    disabled={!bot.initialized}
                                                    className={cn(
                                                        "flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-all",
                                                        selectedChatbot === key 
                                                            ? "bg-blue-600 text-white shadow-sm" 
                                                            : bot.initialized 
                                                                ? "bg-gray-200 text-gray-700 hover:bg-gray-300"
                                                                : "bg-gray-100 text-gray-400 cursor-not-allowed"
                                                    )}
                                                >
                                                    {bot.name}
                                                    {!bot.initialized && (
                                                        <span className="block text-xs opacity-75">Not configured</span>
                                                    )}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* Messages Area */}
                                <div className="flex-1 overflow-y-auto p-4 space-y-3">
                                    {chatMessages[selectedChatbot]?.length === 0 && (
                                        <div className="text-center text-gray-500 mt-8">
                                            <p>üëã Hello! I'm your {selectedChatbot === 'watson' ? 'Watson' : 'Gemini'} weather assistant.</p>
                                            <p className="text-sm mt-2">Ask me about weather, forecasts, or data analysis!</p>
                                        </div>
                                    )}
                                    
                                    {chatMessages[selectedChatbot]?.map((message, index) => (
                                        <div
                                            key={index}
                                            className={cn(
                                                "flex",
                                                message.sender === 'user' ? "justify-end" : "justify-start"
                                            )}
                                        >
                                            <div
                                                className={cn(
                                                    "inline-block max-w-[80%] p-3 rounded-2xl",
                                                    message.sender === 'user' 
                                                        ? "bg-blue-600 text-white" 
                                                        : message.sender === 'error'
                                                        ? "bg-red-100 text-red-800"
                                                        : "bg-gray-100 text-gray-800"
                                                )}
                                            >
                                                {message.text}
                                            </div>
                                        </div>
                                    ))}
                                    
                                    {chatLoading && (
                                        <div className="flex justify-start">
                                            <div className="inline-block bg-gray-100 text-gray-800 p-3 rounded-2xl">
                                                <div className="flex items-center gap-2">
                                                    <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                                                    <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{animationDelay: '0.1s'}}></div>
                                                    <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></div>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Input Area */}
                                <div className="p-4 border-t">
                                    {chatbotConfig?.chatbots && !chatbotConfig.chatbots[selectedChatbot]?.initialized && (
                                        <div className="mb-3 p-2 bg-yellow-50 border border-yellow-200 rounded-lg text-sm text-yellow-800">
                                            ‚ö†Ô∏è {chatbotConfig.chatbots[selectedChatbot]?.name || 'Selected chatbot'} not configured. Please check API settings.
                                        </div>
                                    )}
                                    <div className="flex gap-2">
                                        <input
                                            type="text"
                                            value={chatInput}
                                            onChange={(e) => setChatInput(e.target.value)}
                                            onKeyPress={handleChatKeyPress}
                                            placeholder="Type your message..."
                                            className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900"
                                            disabled={chatLoading || !chatbotConfig?.chatbots?.[selectedChatbot]?.initialized}
                                        />
                                        <button
                                            onClick={sendChatMessage}
                                            disabled={chatLoading || !chatInput.trim() || !chatbotConfig?.chatbots?.[selectedChatbot]?.initialized}
                                            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                        >
                                            ‚Üë
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    </div>
                </div>
            );
        };

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    

</body>
</html>